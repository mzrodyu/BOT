<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CatieBot ç®¡ç†åå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .sidebar-item.active {
        background-color: rgb(79 70 229);
        color: white;
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <!-- Login Modal -->
    <div
      id="loginModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    >
      <div class="bg-white rounded-lg p-8 w-96 shadow-xl">
        <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">
          <i class="fas fa-robot mr-2"></i>CatieBot ç®¡ç†
        </h2>
        <input
          type="password"
          id="adminSecret"
          placeholder="è¾“å…¥ç®¡ç†å¯†ç "
          class="w-full px-4 py-3 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500"
        />
        <button
          onclick="login()"
          class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition"
        >
          ç™»å½•
        </button>
        <p id="loginError" class="text-red-500 text-center mt-3 hidden">
          å¯†ç é”™è¯¯
        </p>
      </div>
    </div>

    <!-- Main Layout -->
    <div id="mainContent" class="hidden flex">
      <!-- Sidebar -->
      <div class="w-64 bg-gray-900 min-h-screen p-4">
        <div class="text-white text-xl font-bold mb-8 flex items-center">
          <i class="fas fa-robot mr-3"></i>CatieBot
        </div>
        <nav class="space-y-2">
          <a
            href="#"
            onclick="showTab('dashboard')"
            class="sidebar-item active flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 transition"
          >
            <i class="fas fa-tachometer-alt mr-3"></i>ä»ªè¡¨ç›˜
          </a>
          <a
            href="#"
            onclick="showTab('knowledge')"
            class="sidebar-item flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 transition"
          >
            <i class="fas fa-book mr-3"></i>çŸ¥è¯†åº“
          </a>
          <a
            href="#"
            onclick="showTab('blacklist')"
            class="sidebar-item flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 transition"
          >
            <i class="fas fa-ban mr-3"></i>é»‘åå•
          </a>
          <a
            href="#"
            onclick="showTab('channels')"
            class="sidebar-item flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 transition"
          >
            <i class="fas fa-hashtag mr-3"></i>é¢‘é“ç™½åå•
          </a>
          <a
            href="#"
            onclick="showTab('memories')"
            class="sidebar-item flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 transition"
          >
            <i class="fas fa-brain mr-3"></i>ç”¨æˆ·è®°å¿†
          </a>
          <a
            href="#"
            onclick="showTab('sensitive')"
            class="sidebar-item flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 transition"
          >
            <i class="fas fa-shield-alt mr-3"></i>æ•æ„Ÿè¯
          </a>
          <div class="border-t border-gray-700 my-4"></div>
          <a
            href="#"
            onclick="showTab('llmconfig')"
            class="sidebar-item flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 transition"
          >
            <i class="fas fa-cog mr-3"></i>APIè®¾ç½®
          </a>
          <a
            href="#"
            onclick="showTab('botconfig')"
            class="sidebar-item flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 transition"
          >
            <i class="fas fa-robot mr-3"></i>Botè®¾ç½®
          </a>
        </nav>
      </div>

      <!-- Content -->
      <div class="flex-1 p-8">
        <!-- Dashboard -->
        <div id="dashboard" class="tab-content active">
          <h1 class="text-3xl font-bold text-gray-800 mb-6">ä»ªè¡¨ç›˜</h1>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl p-6 shadow-sm">
              <div class="flex items-center">
                <div class="p-3 bg-blue-100 rounded-lg">
                  <i class="fas fa-users text-blue-600 text-xl"></i>
                </div>
                <div class="ml-4">
                  <p class="text-gray-500 text-sm">ç”¨æˆ·æ•°</p>
                  <p id="statUsers" class="text-2xl font-bold text-gray-800">
                    -
                  </p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-sm">
              <div class="flex items-center">
                <div class="p-3 bg-green-100 rounded-lg">
                  <i class="fas fa-book text-green-600 text-xl"></i>
                </div>
                <div class="ml-4">
                  <p class="text-gray-500 text-sm">çŸ¥è¯†æ¡ç›®</p>
                  <p
                    id="statKnowledge"
                    class="text-2xl font-bold text-gray-800"
                  >
                    -
                  </p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-sm">
              <div class="flex items-center">
                <div class="p-3 bg-red-100 rounded-lg">
                  <i class="fas fa-ban text-red-600 text-xl"></i>
                </div>
                <div class="ml-4">
                  <p class="text-gray-500 text-sm">é»‘åå•</p>
                  <p
                    id="statBlacklist"
                    class="text-2xl font-bold text-gray-800"
                  >
                    -
                  </p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-sm">
              <div class="flex items-center">
                <div class="p-3 bg-purple-100 rounded-lg">
                  <i class="fas fa-hashtag text-purple-600 text-xl"></i>
                </div>
                <div class="ml-4">
                  <p class="text-gray-500 text-sm">ç™½åå•é¢‘é“</p>
                  <p id="statChannels" class="text-2xl font-bold text-gray-800">
                    -
                  </p>
                </div>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl p-6 shadow-sm">
            <h2 class="text-xl font-bold text-gray-800 mb-4">ç³»ç»ŸçŠ¶æ€</h2>
            <div class="flex items-center text-green-600">
              <i class="fas fa-check-circle mr-2"></i>
              <span>API æœåŠ¡è¿è¡Œæ­£å¸¸</span>
            </div>
          </div>
        </div>

        <!-- Knowledge Base -->
        <div id="knowledge" class="tab-content">
          <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">çŸ¥è¯†åº“ç®¡ç†</h1>
            <button
              onclick="showKnowledgeModal()"
              class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition"
            >
              <i class="fas fa-plus mr-2"></i>æ·»åŠ çŸ¥è¯†
            </button>
          </div>
          <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    æ ‡é¢˜
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    å…³é”®è¯
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    åˆ†ç±»
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    çŠ¶æ€
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    æ“ä½œ
                  </th>
                </tr>
              </thead>
              <tbody
                id="knowledgeTable"
                class="divide-y divide-gray-200"
              ></tbody>
            </table>
          </div>
        </div>

        <!-- Blacklist -->
        <div id="blacklist" class="tab-content">
          <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">é»‘åå•ç®¡ç†</h1>
            <button
              onclick="showBlacklistModal()"
              class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition"
            >
              <i class="fas fa-plus mr-2"></i>æ·»åŠ é»‘åå•
            </button>
          </div>
          <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    Discord ID
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    ç”¨æˆ·å
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    åŸå› 
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    ç±»å‹
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    æ“ä½œ
                  </th>
                </tr>
              </thead>
              <tbody
                id="blacklistTable"
                class="divide-y divide-gray-200"
              ></tbody>
            </table>
          </div>
        </div>

        <!-- Channels -->
        <div id="channels" class="tab-content">
          <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">é¢‘é“ç™½åå•</h1>
            <button
              onclick="showChannelModal()"
              class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition"
            >
              <i class="fas fa-plus mr-2"></i>æ·»åŠ é¢‘é“
            </button>
          </div>
          <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    é¢‘é“ID
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    é¢‘é“å
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    æœåŠ¡å™¨ID
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    æ“ä½œ
                  </th>
                </tr>
              </thead>
              <tbody
                id="channelsTable"
                class="divide-y divide-gray-200"
              ></tbody>
            </table>
          </div>
        </div>

        <!-- Memories -->
        <div id="memories" class="tab-content">
          <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">ç”¨æˆ·è®°å¿†</h1>
            <div class="flex space-x-2">
              <select id="userSelect" class="px-4 py-2 border rounded-lg">
                <option value="">é€‰æ‹©ç”¨æˆ·...</option>
              </select>
              <button
                onclick="summarizeUser()"
                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"
              >
                <i class="fas fa-brain mr-2"></i>æ±‡æ€»è®°å¿†
              </button>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    ç”¨æˆ·ID
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    è®°å¿†æ‘˜è¦
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    æ›´æ–°æ—¶é—´
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    æ“ä½œ
                  </th>
                </tr>
              </thead>
              <tbody
                id="memoriesTable"
                class="divide-y divide-gray-200"
              ></tbody>
            </table>
          </div>
        </div>

        <!-- Memory Edit Modal -->
        <div
          id="memoryModal"
          class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
        >
          <div
            class="bg-white rounded-lg p-6 w-[600px] max-h-[80vh] overflow-y-auto"
          >
            <h2 class="text-xl font-bold mb-4">ç¼–è¾‘ç”¨æˆ·è®°å¿†</h2>
            <input type="hidden" id="memUserId" />
            <textarea
              id="memSummary"
              placeholder="è®°å¿†æ‘˜è¦"
              rows="10"
              class="w-full px-4 py-2 border rounded-lg mb-4"
            ></textarea>
            <div class="flex justify-end space-x-3">
              <button
                onclick="hideMemoryModal()"
                class="px-4 py-2 border rounded-lg hover:bg-gray-100"
              >
                å–æ¶ˆ
              </button>
              <button
                onclick="saveMemory()"
                class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
              >
                ä¿å­˜
              </button>
            </div>
          </div>
        </div>

        <!-- LLM Config -->
        <div id="llmconfig" class="tab-content">
          <h1 class="text-3xl font-bold text-gray-800 mb-6">APIè®¾ç½®</h1>
          <div class="bg-white rounded-xl shadow-sm p-6">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                  >APIåœ°å€</label
                >
                <input
                  type="text"
                  id="llmBaseUrl"
                  placeholder="https://api.openai.com/v1"
                  class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                  >APIå¯†é’¥</label
                >
                <input
                  type="password"
                  id="llmApiKey"
                  placeholder="sk-..."
                  class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                  >æ¨¡å‹åç§°</label
                >
                <div class="flex space-x-2">
                  <select
                    id="llmModel"
                    class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  >
                    <option value="">è¯·é€‰æ‹©æˆ–æ‰‹åŠ¨è¾“å…¥</option>
                  </select>
                  <input
                    type="text"
                    id="llmModelCustom"
                    placeholder="æˆ–æ‰‹åŠ¨è¾“å…¥æ¨¡å‹å"
                    class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  />
                  <button
                    onclick="fetchModels()"
                    class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition"
                  >
                    <i class="fas fa-sync-alt mr-1"></i>æ‹‰å–
                  </button>
                </div>
                <p id="modelStatus" class="text-sm text-gray-500 mt-1"></p>
              </div>
              <div>
                <label class="flex items-center">
                  <input
                    type="checkbox"
                    id="llmStream"
                    class="mr-2 w-4 h-4"
                    checked
                  />
                  <span class="text-sm font-medium text-gray-700"
                    >å¯ç”¨æµå¼ä¼ è¾“</span
                  >
                </label>
                <p class="text-sm text-gray-500 mt-1">
                  å¼€å¯åBotå›å¤ä¼šå®æ—¶æ˜¾ç¤ºï¼Œå…³é—­åˆ™ç­‰å¾…å®Œæ•´å›å¤
                </p>
              </div>
              <button
                onclick="saveLLMConfig()"
                class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition"
              >
                <i class="fas fa-save mr-2"></i>ä¿å­˜
              </button>
            </div>
          </div>
        </div>

        <!-- Bot Config -->
        <div id="botconfig" class="tab-content">
          <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Botè®¾ç½®</h1>
            <button
              onclick="showBotConfigModal()"
              class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition"
            >
              <i class="fas fa-plus mr-2"></i>æ·»åŠ Bot
            </button>
          </div>
          <div id="botConfigList" class="space-y-4"></div>
        </div>

        <!-- Sensitive Words -->
        <div id="sensitive" class="tab-content">
          <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">æ•æ„Ÿè¯ç®¡ç†</h1>
            <button
              onclick="showSensitiveModal()"
              class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition"
            >
              <i class="fas fa-plus mr-2"></i>æ·»åŠ æ•æ„Ÿè¯
            </button>
          </div>
          <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    æ•æ„Ÿè¯
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    åˆ†ç±»
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    çŠ¶æ€
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    æ“ä½œ
                  </th>
                </tr>
              </thead>
              <tbody
                id="sensitiveTable"
                class="divide-y divide-gray-200"
              ></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Knowledge Modal -->
    <div
      id="knowledgeModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white rounded-lg p-6 w-[600px] max-h-[80vh] overflow-y-auto"
      >
        <h2 class="text-xl font-bold mb-4">æ·»åŠ çŸ¥è¯†</h2>
        <input
          type="text"
          id="kbTitle"
          placeholder="æ ‡é¢˜"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <textarea
          id="kbContent"
          placeholder="å†…å®¹"
          rows="6"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        ></textarea>
        <input
          type="text"
          id="kbKeywords"
          placeholder="å…³é”®è¯ï¼ˆé€—å·åˆ†éš”ï¼‰"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <input
          type="text"
          id="kbCategory"
          placeholder="åˆ†ç±»"
          class="w-full px-4 py-2 border rounded-lg mb-4"
        />
        <div class="flex justify-end space-x-3">
          <button
            onclick="hideKnowledgeModal()"
            class="px-4 py-2 border rounded-lg hover:bg-gray-100"
          >
            å–æ¶ˆ
          </button>
          <button
            onclick="addKnowledge()"
            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
          >
            ä¿å­˜
          </button>
        </div>
      </div>
    </div>

    <!-- Blacklist Modal -->
    <div
      id="blacklistModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div class="bg-white rounded-lg p-6 w-96">
        <h2 class="text-xl font-bold mb-4">æ·»åŠ é»‘åå•</h2>
        <input
          type="text"
          id="blDiscordId"
          placeholder="Discord ID"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <input
          type="text"
          id="blUsername"
          placeholder="ç”¨æˆ·åï¼ˆå¯é€‰ï¼‰"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <input
          type="text"
          id="blReason"
          placeholder="åŸå› ï¼ˆå¯é€‰ï¼‰"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <label class="flex items-center mb-3">
          <input
            type="checkbox"
            id="blPermanent"
            class="mr-2"
            onchange="toggleDuration()"
          />
          <span>æ°¸ä¹…æ‹‰é»‘</span>
        </label>
        <input
          type="number"
          id="blDuration"
          placeholder="æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰"
          class="w-full px-4 py-2 border rounded-lg mb-4"
        />
        <div class="flex justify-end space-x-3">
          <button
            onclick="hideBlacklistModal()"
            class="px-4 py-2 border rounded-lg hover:bg-gray-100"
          >
            å–æ¶ˆ
          </button>
          <button
            onclick="addBlacklist()"
            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
          >
            æ·»åŠ 
          </button>
        </div>
      </div>
    </div>

    <!-- Channel Modal -->
    <div
      id="channelModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white rounded-lg p-6 w-[500px] max-h-[80vh] overflow-y-auto"
      >
        <h2 class="text-xl font-bold mb-4">æ·»åŠ é¢‘é“</h2>

        <!-- ä»Botæ‹‰å–é¢‘é“ -->
        <div class="mb-4 p-3 bg-gray-50 rounded-lg">
          <div class="flex items-center space-x-2 mb-2">
            <input
              type="text"
              id="chBotId"
              placeholder="Bot IDï¼ˆå¦‚ï¼šyuï¼‰"
              class="flex-1 px-3 py-2 border rounded-lg text-sm"
              value="yu"
            />
            <button
              onclick="fetchBotChannels()"
              class="bg-gray-600 text-white px-3 py-2 rounded-lg hover:bg-gray-700 text-sm"
            >
              <i class="fas fa-sync-alt mr-1"></i>æ‹‰å–é¢‘é“
            </button>
          </div>
          <div id="channelTree" class="max-h-60 overflow-y-auto text-sm"></div>
        </div>

        <div class="border-t pt-4">
          <p class="text-sm text-gray-500 mb-2">æˆ–æ‰‹åŠ¨è¾“å…¥ï¼š</p>
          <input
            type="text"
            id="chChannelId"
            placeholder="é¢‘é“ID"
            class="w-full px-4 py-2 border rounded-lg mb-3"
          />
          <input
            type="text"
            id="chGuildId"
            placeholder="æœåŠ¡å™¨ID"
            class="w-full px-4 py-2 border rounded-lg mb-3"
          />
          <input
            type="text"
            id="chName"
            placeholder="é¢‘é“åï¼ˆå¯é€‰ï¼‰"
            class="w-full px-4 py-2 border rounded-lg mb-4"
          />
        </div>
        <div class="flex justify-end space-x-3">
          <button
            onclick="hideChannelModal()"
            class="px-4 py-2 border rounded-lg hover:bg-gray-100"
          >
            å–æ¶ˆ
          </button>
          <button
            onclick="addChannel()"
            class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
          >
            æ·»åŠ 
          </button>
        </div>
      </div>
    </div>

    <!-- Bot Config Modal -->
    <div
      id="botConfigModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white rounded-lg p-6 w-[600px] max-h-[80vh] overflow-y-auto"
      >
        <h2 class="text-xl font-bold mb-4">Boté…ç½®</h2>
        <input
          type="text"
          id="bcBotId"
          placeholder="Bot IDï¼ˆå¦‚ï¼šdefaultï¼‰"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <input
          type="text"
          id="bcBotName"
          placeholder="Botåç§°"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <textarea
          id="bcSystemPrompt"
          placeholder="äººè®¾ï¼ˆSystem Promptï¼‰"
          rows="8"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        ></textarea>
        <input
          type="number"
          id="bcContextLimit"
          placeholder="ä¸Šä¸‹æ–‡æ¡æ•°ï¼ˆé»˜è®¤10ï¼‰"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <input
          type="text"
          id="bcAdminIds"
          placeholder="ç®¡ç†å‘˜IDï¼ˆé€—å·åˆ†éš”ï¼Œå¦‚ï¼š123,456ï¼‰"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <p class="text-sm text-gray-500 mb-3">
          ç®¡ç†å‘˜å¯ä½¿ç”¨Botæ–œæ å‘½ä»¤ç®¡ç†é»‘åå•å’Œé¢‘é“ç™½åå•
        </p>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2"
            >å¯¹è¯æ¨¡å¼</label
          >
          <div class="flex space-x-4">
            <label class="flex items-center">
              <input
                type="radio"
                name="chatMode"
                id="bcChatModeChat"
                value="chat"
                checked
                class="mr-2"
              />
              <span class="text-sm">èŠå¤©æ¨¡å¼ï¼ˆä¿ç•™ä¸Šä¸‹æ–‡ï¼‰</span>
            </label>
            <label class="flex items-center">
              <input
                type="radio"
                name="chatMode"
                id="bcChatModeQA"
                value="qa"
                class="mr-2"
              />
              <span class="text-sm">ç­”ç–‘æ¨¡å¼ï¼ˆåªçœ‹å½“å‰é—®é¢˜ï¼‰</span>
            </label>
          </div>
        </div>
        <div class="flex justify-end space-x-3">
          <button
            onclick="hideBotConfigModal()"
            class="px-4 py-2 border rounded-lg hover:bg-gray-100"
          >
            å–æ¶ˆ
          </button>
          <button
            onclick="saveBotConfig()"
            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
          >
            ä¿å­˜
          </button>
        </div>
      </div>
    </div>

    <!-- Sensitive Word Modal -->
    <div
      id="sensitiveModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div class="bg-white rounded-lg p-6 w-96">
        <h2 class="text-xl font-bold mb-4">æ·»åŠ æ•æ„Ÿè¯</h2>
        <input
          type="text"
          id="swWord"
          placeholder="æ•æ„Ÿè¯"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <input
          type="text"
          id="swCategory"
          placeholder="åˆ†ç±»ï¼ˆå¯é€‰ï¼‰"
          class="w-full px-4 py-2 border rounded-lg mb-4"
        />
        <div class="flex justify-end space-x-3">
          <button
            onclick="hideSensitiveModal()"
            class="px-4 py-2 border rounded-lg hover:bg-gray-100"
          >
            å–æ¶ˆ
          </button>
          <button
            onclick="addSensitiveWord()"
            class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700"
          >
            æ·»åŠ 
          </button>
        </div>
      </div>
    </div>

    <script>
      let adminSecret = "";
      const API_BASE = "";

      async function api(endpoint, method = "GET", body = null) {
        const options = {
          method,
          headers: {
            "Content-Type": "application/json",
            "X-Admin-Secret": adminSecret,
          },
        };
        if (body) options.body = JSON.stringify(body);
        const resp = await fetch(API_BASE + endpoint, options);
        if (!resp.ok) throw new Error("API Error");
        return resp.json();
      }

      async function login() {
        adminSecret = document.getElementById("adminSecret").value;
        try {
          await api("/api/admin/blacklist");
          document.getElementById("loginModal").classList.add("hidden");
          document.getElementById("mainContent").classList.remove("hidden");
          loadDashboard();
        } catch {
          document.getElementById("loginError").classList.remove("hidden");
        }
      }

      function showTab(tabId) {
        document
          .querySelectorAll(".tab-content")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".sidebar-item")
          .forEach((s) => s.classList.remove("active"));
        document.getElementById(tabId).classList.add("active");
        event.target.closest(".sidebar-item").classList.add("active");

        switch (tabId) {
          case "dashboard":
            loadDashboard();
            break;
          case "knowledge":
            loadKnowledge();
            break;
          case "blacklist":
            loadBlacklist();
            break;
          case "channels":
            loadChannels();
            break;
          case "memories":
            loadMemories();
            break;
          case "sensitive":
            loadSensitiveWords();
            break;
        }
      }

      async function loadDashboard() {
        try {
          const [users, knowledge, blacklist, channels] = await Promise.all([
            api("/api/admin/users"),
            api("/api/knowledge/"),
            api("/api/admin/blacklist"),
            api("/api/admin/channels"),
          ]);
          document.getElementById("statUsers").textContent = users.length;
          document.getElementById("statKnowledge").textContent =
            knowledge.length;
          document.getElementById("statBlacklist").textContent =
            blacklist.length;
          document.getElementById("statChannels").textContent = channels.length;
        } catch (e) {
          console.error(e);
        }
      }

      async function loadKnowledge() {
        const data = await api("/api/knowledge/");
        document.getElementById("knowledgeTable").innerHTML = data
          .map(
            (kb) => `
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-900">${kb.title}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${
                      kb.keywords || "-"
                    }</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${
                      kb.category || "-"
                    }</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs rounded-full ${
                          kb.is_active
                            ? "bg-green-100 text-green-800"
                            : "bg-gray-100 text-gray-800"
                        }">
                            ${kb.is_active ? "å¯ç”¨" : "ç¦ç”¨"}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="deleteKnowledge(${
                          kb.id
                        })" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      async function loadBlacklist() {
        const data = await api("/api/admin/blacklist");
        document.getElementById("blacklistTable").innerHTML = data
          .map(
            (bl) => `
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-900">${
                      bl.discord_id
                    }</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${
                      bl.username || "-"
                    }</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${
                      bl.reason || "-"
                    }</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs rounded-full ${
                          bl.is_permanent
                            ? "bg-red-100 text-red-800"
                            : "bg-yellow-100 text-yellow-800"
                        }">
                            ${bl.is_permanent ? "æ°¸ä¹…" : "é™æ—¶"}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="removeBlacklist('${
                          bl.discord_id
                        }')" class="text-green-600 hover:text-green-800">
                            <i class="fas fa-unlock"></i>
                        </button>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      async function loadChannels() {
        const data = await api("/api/admin/channels");
        document.getElementById("channelsTable").innerHTML = data
          .map(
            (ch) => `
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-900">${
                      ch.channel_id
                    }</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${
                      ch.channel_name || "-"
                    }</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${
                      ch.guild_id
                    }</td>
                    <td class="px-6 py-4">
                        <button onclick="removeChannel('${
                          ch.channel_id
                        }')" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      async function loadMemories() {
        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        try {
          const users = await api("/api/admin/users");
          const userSelect = document.getElementById("userSelect");
          userSelect.innerHTML =
            '<option value="">é€‰æ‹©ç”¨æˆ·...</option>' +
            users
              .map(
                (u) =>
                  `<option value="${u.discord_id}">${u.username} (${u.discord_id})</option>`
              )
              .join("");
        } catch (e) {}

        // åŠ è½½è®°å¿†åˆ—è¡¨
        const data = await api("/api/admin/memories");
        document.getElementById("memoriesTable").innerHTML =
          data.length === 0
            ? '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">æš‚æ— è®°å¿†ï¼Œé€‰æ‹©ç”¨æˆ·åç‚¹å‡»"æ±‡æ€»è®°å¿†"ç”Ÿæˆ</td></tr>'
            : data
                .map(
                  (m) => `
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-900">${
                      m.user_id
                    }</td>
                    <td class="px-6 py-4 text-sm text-gray-500 max-w-md truncate">${
                      m.summary || "-"
                    }</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${new Date(
                      m.updated_at
                    ).toLocaleString()}</td>
                    <td class="px-6 py-4">
                        <button onclick="editMemory(${m.user_id}, \`${(
                    m.summary || ""
                  )
                    .replace(/`/g, "\\`")
                    .replace(
                      /\n/g,
                      "\\n"
                    )}\`)" class="text-indigo-600 hover:text-indigo-800 mr-2">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteMemory(${
                          m.user_id
                        })" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `
                )
                .join("");
      }

      async function summarizeUser() {
        const discordId = document.getElementById("userSelect").value;
        if (!discordId) {
          alert("è¯·å…ˆé€‰æ‹©ç”¨æˆ·");
          return;
        }
        try {
          const btn = event.target;
          btn.disabled = true;
          btn.innerHTML =
            '<i class="fas fa-spinner fa-spin mr-2"></i>æ±‡æ€»ä¸­...';
          await api(`/api/admin/memories/summarize/${discordId}`, "POST");
          alert("æ±‡æ€»æˆåŠŸï¼");
          loadMemories();
        } catch (e) {
          alert("æ±‡æ€»å¤±è´¥: " + e.message);
        } finally {
          const btn = document.querySelector(
            'button[onclick="summarizeUser()"]'
          );
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-brain mr-2"></i>æ±‡æ€»è®°å¿†';
        }
      }

      function editMemory(userId, summary) {
        document.getElementById("memUserId").value = userId;
        document.getElementById("memSummary").value = summary;
        document.getElementById("memoryModal").classList.remove("hidden");
      }

      function hideMemoryModal() {
        document.getElementById("memoryModal").classList.add("hidden");
      }

      async function saveMemory() {
        const userId = document.getElementById("memUserId").value;
        const summary = document.getElementById("memSummary").value;
        try {
          await api(`/api/admin/memories/${userId}`, "PUT", { summary });
          hideMemoryModal();
          loadMemories();
        } catch (e) {
          alert("ä¿å­˜å¤±è´¥: " + e.message);
        }
      }

      async function deleteMemory(userId) {
        if (confirm("ç¡®å®šåˆ é™¤æ­¤è®°å¿†ï¼Ÿ")) {
          await api(`/api/admin/memories/${userId}`, "DELETE");
          loadMemories();
        }
      }

      async function loadSensitiveWords() {
        const data = await api("/api/admin/sensitive-words");
        document.getElementById("sensitiveTable").innerHTML = data
          .map(
            (sw) => `
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-900">${sw.word}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${
                      sw.category || "-"
                    }</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs rounded-full ${
                          sw.is_active
                            ? "bg-green-100 text-green-800"
                            : "bg-gray-100 text-gray-800"
                        }">
                            ${sw.is_active ? "å¯ç”¨" : "ç¦ç”¨"}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="removeSensitiveWord(${
                          sw.id
                        })" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      // Modal functions
      function showKnowledgeModal() {
        document.getElementById("knowledgeModal").classList.remove("hidden");
      }
      function hideKnowledgeModal() {
        document.getElementById("knowledgeModal").classList.add("hidden");
      }
      function showBlacklistModal() {
        document.getElementById("blacklistModal").classList.remove("hidden");
      }
      function hideBlacklistModal() {
        document.getElementById("blacklistModal").classList.add("hidden");
      }
      function showChannelModal() {
        document.getElementById("channelModal").classList.remove("hidden");
      }
      function hideChannelModal() {
        document.getElementById("channelModal").classList.add("hidden");
      }
      function showSensitiveModal() {
        document.getElementById("sensitiveModal").classList.remove("hidden");
      }
      function hideSensitiveModal() {
        document.getElementById("sensitiveModal").classList.add("hidden");
      }

      function toggleDuration() {
        document.getElementById("blDuration").disabled =
          document.getElementById("blPermanent").checked;
      }

      // CRUD operations
      async function addKnowledge() {
        await api("/api/knowledge/", "POST", {
          title: document.getElementById("kbTitle").value,
          content: document.getElementById("kbContent").value,
          keywords: document.getElementById("kbKeywords").value,
          category: document.getElementById("kbCategory").value,
        });
        hideKnowledgeModal();
        loadKnowledge();
      }

      async function deleteKnowledge(id) {
        if (confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) {
          await api(`/api/knowledge/${id}`, "DELETE");
          loadKnowledge();
        }
      }

      async function addBlacklist() {
        await api("/api/admin/blacklist", "POST", {
          discord_id: document.getElementById("blDiscordId").value,
          username: document.getElementById("blUsername").value,
          reason: document.getElementById("blReason").value,
          is_permanent: document.getElementById("blPermanent").checked,
          duration_minutes:
            parseInt(document.getElementById("blDuration").value) || null,
        });
        hideBlacklistModal();
        loadBlacklist();
      }

      async function removeBlacklist(discordId) {
        if (confirm("ç¡®å®šè§£ç¦ï¼Ÿ")) {
          await api(`/api/admin/blacklist/${discordId}`, "DELETE");
          loadBlacklist();
        }
      }

      async function addChannel() {
        const botId = document.getElementById("chBotId").value || "yu";
        await api("/api/admin/channels", "POST", {
          bot_id: botId,
          channel_id: document.getElementById("chChannelId").value,
          guild_id: document.getElementById("chGuildId").value,
          channel_name: document.getElementById("chName").value,
        });
        hideChannelModal();
        loadChannels();
      }

      async function removeChannel(channelId) {
        if (confirm("ç¡®å®šç§»é™¤ï¼Ÿ")) {
          await api(`/api/admin/channels/${channelId}`, "DELETE");
          loadChannels();
        }
      }

      async function fetchBotChannels() {
        const botId = document.getElementById("chBotId").value || "yu";
        const tree = document.getElementById("channelTree");
        tree.innerHTML = '<p class="text-gray-500">æ­£åœ¨è·å–...</p>';

        try {
          const guilds = await api(`/api/admin/bot-channels/${botId}`);
          if (!guilds || guilds.length === 0) {
            tree.innerHTML =
              '<p class="text-gray-500">æš‚æ— æ•°æ®ï¼Œè¯·å…ˆå¯åŠ¨Bot</p>';
            return;
          }

          let html = "";
          for (const guild of guilds) {
            html += `<div class="mb-3">
              <div class="font-bold text-gray-700 mb-1">ğŸ“ ${guild.guild_name}</div>
              <div class="pl-4 space-y-1">`;

            for (const ch of guild.channels) {
              const icon =
                ch.type === "forum" ? "ğŸ“‹" : ch.type === "thread" ? "ğŸ’¬" : "#";
              html += `<div class="flex items-center justify-between hover:bg-gray-100 px-2 py-1 rounded cursor-pointer"
                onclick="selectChannel('${ch.channel_id}', '${guild.guild_id}', '${ch.channel_name}')">
                <span>${icon} ${ch.channel_name}</span>
                <button class="text-xs text-purple-600 hover:text-purple-800">é€‰æ‹©</button>
              </div>`;
            }
            html += "</div></div>";
          }
          tree.innerHTML = html;
        } catch (e) {
          tree.innerHTML = '<p class="text-red-500">è·å–å¤±è´¥</p>';
        }
      }

      function selectChannel(channelId, guildId, channelName) {
        document.getElementById("chChannelId").value = channelId;
        document.getElementById("chGuildId").value = guildId;
        document.getElementById("chName").value = channelName;
      }

      async function addSensitiveWord() {
        await api("/api/admin/sensitive-words", "POST", {
          word: document.getElementById("swWord").value,
          category: document.getElementById("swCategory").value,
        });
        hideSensitiveModal();
        loadSensitiveWords();
      }

      async function removeSensitiveWord(id) {
        if (confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) {
          await api(`/api/admin/sensitive-words/${id}`, "DELETE");
          loadSensitiveWords();
        }
      }

      // LLM Config
      async function loadLLMConfig() {
        try {
          const config = await api("/api/admin/llm-config");
          document.getElementById("llmBaseUrl").value = config.base_url || "";
          document.getElementById("llmApiKey").value = config.api_key
            ? "********"
            : "";
          document.getElementById("llmModelCustom").value = config.model || "";
          document.getElementById("llmStream").checked =
            config.stream !== false;

          // ä¿å­˜å½“å‰æ¨¡å‹åˆ°æ‰‹åŠ¨è¾“å…¥æ¡†ï¼Œå¹¶å°è¯•æ·»åŠ åˆ°ä¸‹æ‹‰åˆ—è¡¨
          const currentModel = config.model || "";
          document.getElementById("llmModelCustom").value = currentModel;
          if (currentModel) {
            const select = document.getElementById("llmModel");
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            let exists = false;
            for (let opt of select.options) {
              if (opt.value === currentModel) {
                exists = true;
                opt.selected = true;
                break;
              }
            }
            if (!exists) {
              const option = document.createElement("option");
              option.value = currentModel;
              option.textContent = currentModel + " (å½“å‰)";
              option.selected = true;
              select.appendChild(option);
            }
          }
        } catch (e) {
          console.error(e);
        }
      }

      async function saveLLMConfig() {
        const apiKey = document.getElementById("llmApiKey").value;
        const modelSelect = document.getElementById("llmModel").value;
        const modelCustom = document.getElementById("llmModelCustom").value;
        const model = modelCustom || modelSelect;
        const stream = document.getElementById("llmStream").checked;

        const data = {
          base_url: document.getElementById("llmBaseUrl").value,
          model: model,
          stream: stream,
        };
        if (apiKey && apiKey !== "********") {
          data.api_key = apiKey;
        }
        await api("/api/admin/llm-config", "PUT", data);
        alert("ä¿å­˜æˆåŠŸï¼");
      }

      async function fetchModels() {
        const status = document.getElementById("modelStatus");
        status.textContent = "æ­£åœ¨è·å–æ¨¡å‹åˆ—è¡¨...";
        status.className = "text-sm text-blue-500 mt-1";

        try {
          const result = await api("/api/admin/llm-models");
          const select = document.getElementById("llmModel");
          select.innerHTML = '<option value="">è¯·é€‰æ‹©æ¨¡å‹</option>';

          for (const model of result.models) {
            const option = document.createElement("option");
            option.value = model;
            option.textContent = model;
            select.appendChild(option);
          }

          status.textContent = `æˆåŠŸè·å– ${result.models.length} ä¸ªæ¨¡å‹`;
          status.className = "text-sm text-green-500 mt-1";
        } catch (e) {
          status.textContent = "è·å–å¤±è´¥ï¼š" + (e.message || "è¯·æ£€æŸ¥APIé…ç½®");
          status.className = "text-sm text-red-500 mt-1";
        }
      }

      // Bot Config
      async function loadBotConfigs() {
        try {
          const configs = await api("/api/admin/bot-config");
          document.getElementById("botConfigList").innerHTML =
            configs.length === 0
              ? '<div class="bg-white rounded-xl p-6 shadow-sm text-gray-500">æš‚æ— Boté…ç½®ï¼Œç‚¹å‡»å³ä¸Šè§’æ·»åŠ </div>'
              : configs
                  .map(
                    (bc) => `
              <div class="bg-white rounded-xl p-6 shadow-sm">
                <div class="flex justify-between items-start">
                  <div>
                    <h3 class="text-lg font-bold text-gray-800">${
                      bc.bot_name || bc.bot_id
                    }</h3>
                    <p class="text-sm text-gray-500">ID: ${bc.bot_id}</p>
                  </div>
                  <div class="flex space-x-2">
                    <button onclick="editBotConfig('${
                      bc.bot_id
                    }')" class="text-indigo-600 hover:text-indigo-800">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteBotConfig('${
                      bc.bot_id
                    }')" class="text-red-600 hover:text-red-800">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
                <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
                  <div><span class="text-gray-500">ä¸Šä¸‹æ–‡æ¡æ•°ï¼š</span>${
                    bc.context_limit
                  }</div>
                  <div><span class="text-gray-500">çŠ¶æ€ï¼š</span>${
                    bc.is_active ? "å¯ç”¨" : "ç¦ç”¨"
                  }</div>
                </div>
                <div class="mt-3 text-sm text-gray-600 truncate">
                  <span class="text-gray-500">äººè®¾ï¼š</span>${(
                    bc.system_prompt || ""
                  ).substring(0, 100)}...
                </div>
              </div>
            `
                  )
                  .join("");
        } catch (e) {
          console.error(e);
        }
      }

      let editingBotId = null;

      function showBotConfigModal() {
        editingBotId = null;
        document.getElementById("bcBotId").value = "";
        document.getElementById("bcBotId").disabled = false;
        document.getElementById("bcBotName").value = "";
        document.getElementById("bcSystemPrompt").value = "";
        document.getElementById("bcContextLimit").value = "10";
        document.getElementById("bcAdminIds").value = "";
        document.getElementById("bcChatModeChat").checked = true;
        document.getElementById("botConfigModal").classList.remove("hidden");
      }

      function hideBotConfigModal() {
        document.getElementById("botConfigModal").classList.add("hidden");
      }

      async function editBotConfig(botId) {
        editingBotId = botId;
        const config = await api(`/api/admin/bot-config/${botId}`);
        document.getElementById("bcBotId").value = config.bot_id;
        document.getElementById("bcBotId").disabled = true;
        document.getElementById("bcBotName").value = config.bot_name || "";
        document.getElementById("bcSystemPrompt").value =
          config.system_prompt || "";
        document.getElementById("bcContextLimit").value =
          config.context_limit || 10;
        document.getElementById("bcAdminIds").value = config.admin_ids || "";
        if (config.chat_mode === "qa") {
          document.getElementById("bcChatModeQA").checked = true;
        } else {
          document.getElementById("bcChatModeChat").checked = true;
        }
        document.getElementById("botConfigModal").classList.remove("hidden");
      }

      async function saveBotConfig() {
        const botId = editingBotId || document.getElementById("bcBotId").value;
        const chatMode = document.getElementById("bcChatModeQA").checked
          ? "qa"
          : "chat";
        const data = {
          bot_id: botId,
          bot_name: document.getElementById("bcBotName").value,
          system_prompt: document.getElementById("bcSystemPrompt").value,
          context_limit:
            parseInt(document.getElementById("bcContextLimit").value) || 10,
          admin_ids: document.getElementById("bcAdminIds").value,
          chat_mode: chatMode,
        };

        if (editingBotId) {
          await api(`/api/admin/bot-config/${botId}`, "PUT", data);
        } else {
          await api("/api/admin/bot-config", "POST", data);
        }
        hideBotConfigModal();
        loadBotConfigs();
      }

      async function deleteBotConfig(botId) {
        if (confirm("ç¡®å®šåˆ é™¤æ­¤Boté…ç½®ï¼Ÿ")) {
          await api(`/api/admin/bot-config/${botId}`, "DELETE");
          loadBotConfigs();
        }
      }

      // Update showTab to handle new tabs
      const originalShowTab = showTab;
      showTab = function (tabId) {
        document
          .querySelectorAll(".tab-content")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".sidebar-item")
          .forEach((s) => s.classList.remove("active"));
        document.getElementById(tabId).classList.add("active");
        event.target.closest(".sidebar-item").classList.add("active");

        switch (tabId) {
          case "dashboard":
            loadDashboard();
            break;
          case "knowledge":
            loadKnowledge();
            break;
          case "blacklist":
            loadBlacklist();
            break;
          case "channels":
            loadChannels();
            break;
          case "memories":
            loadMemories();
            break;
          case "sensitive":
            loadSensitiveWords();
            break;
          case "llmconfig":
            loadLLMConfig();
            break;
          case "botconfig":
            loadBotConfigs();
            break;
        }
      };

      // Enter key login
      document
        .getElementById("adminSecret")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter") login();
        });
    </script>
  </body>
</html>
