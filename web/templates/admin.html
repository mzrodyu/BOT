<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CatieBot 管理后台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .sidebar-item.active {
        background-color: rgb(79 70 229);
        color: white;
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <!-- Login Modal -->
    <div
      id="loginModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    >
      <div class="bg-white rounded-lg p-8 w-96 shadow-xl">
        <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">
          <i class="fas fa-robot mr-2"></i>CatieBot 管理
        </h2>
        <input
          type="password"
          id="adminSecret"
          placeholder="输入管理密码"
          class="w-full px-4 py-3 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500"
        />
        <button
          onclick="login()"
          class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition"
        >
          登录
        </button>
        <p id="loginError" class="text-red-500 text-center mt-3 hidden">
          密码错误
        </p>
      </div>
    </div>

    <!-- Main Layout -->
    <div id="mainContent" class="hidden flex">
      <!-- Sidebar -->
      <div class="w-64 bg-gray-900 min-h-screen p-4">
        <div class="text-white text-xl font-bold mb-8 flex items-center">
          <i class="fas fa-robot mr-3"></i>CatieBot
        </div>
        <nav class="space-y-2">
          <a
            href="#"
            onclick="showTab('dashboard')"
            class="sidebar-item active flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 transition"
          >
            <i class="fas fa-tachometer-alt mr-3"></i>仪表盘
          </a>
          <a
            href="#"
            onclick="showTab('knowledge')"
            class="sidebar-item flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 transition"
          >
            <i class="fas fa-book mr-3"></i>知识库
          </a>
          <a
            href="#"
            onclick="showTab('blacklist')"
            class="sidebar-item flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 transition"
          >
            <i class="fas fa-ban mr-3"></i>黑名单
          </a>
          <a
            href="#"
            onclick="showTab('channels')"
            class="sidebar-item flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 transition"
          >
            <i class="fas fa-hashtag mr-3"></i>频道白名单
          </a>
          <a
            href="#"
            onclick="showTab('memories')"
            class="sidebar-item flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 transition"
          >
            <i class="fas fa-brain mr-3"></i>用户记忆
          </a>
          <a
            href="#"
            onclick="showTab('sensitive')"
            class="sidebar-item flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 transition"
          >
            <i class="fas fa-shield-alt mr-3"></i>敏感词
          </a>
          <div class="border-t border-gray-700 my-4"></div>
          <a
            href="#"
            onclick="showTab('llmconfig')"
            class="sidebar-item flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 transition"
          >
            <i class="fas fa-cog mr-3"></i>API设置
          </a>
          <a
            href="#"
            onclick="showTab('botconfig')"
            class="sidebar-item flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 transition"
          >
            <i class="fas fa-robot mr-3"></i>Bot设置
          </a>
        </nav>
      </div>

      <!-- Content -->
      <div class="flex-1 p-8">
        <!-- Dashboard -->
        <div id="dashboard" class="tab-content active">
          <h1 class="text-3xl font-bold text-gray-800 mb-6">仪表盘</h1>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl p-6 shadow-sm">
              <div class="flex items-center">
                <div class="p-3 bg-blue-100 rounded-lg">
                  <i class="fas fa-users text-blue-600 text-xl"></i>
                </div>
                <div class="ml-4">
                  <p class="text-gray-500 text-sm">用户数</p>
                  <p id="statUsers" class="text-2xl font-bold text-gray-800">
                    -
                  </p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-sm">
              <div class="flex items-center">
                <div class="p-3 bg-green-100 rounded-lg">
                  <i class="fas fa-book text-green-600 text-xl"></i>
                </div>
                <div class="ml-4">
                  <p class="text-gray-500 text-sm">知识条目</p>
                  <p
                    id="statKnowledge"
                    class="text-2xl font-bold text-gray-800"
                  >
                    -
                  </p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-sm">
              <div class="flex items-center">
                <div class="p-3 bg-red-100 rounded-lg">
                  <i class="fas fa-ban text-red-600 text-xl"></i>
                </div>
                <div class="ml-4">
                  <p class="text-gray-500 text-sm">黑名单</p>
                  <p
                    id="statBlacklist"
                    class="text-2xl font-bold text-gray-800"
                  >
                    -
                  </p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-sm">
              <div class="flex items-center">
                <div class="p-3 bg-purple-100 rounded-lg">
                  <i class="fas fa-hashtag text-purple-600 text-xl"></i>
                </div>
                <div class="ml-4">
                  <p class="text-gray-500 text-sm">白名单频道</p>
                  <p id="statChannels" class="text-2xl font-bold text-gray-800">
                    -
                  </p>
                </div>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl p-6 shadow-sm">
            <h2 class="text-xl font-bold text-gray-800 mb-4">系统状态</h2>
            <div class="flex items-center text-green-600">
              <i class="fas fa-check-circle mr-2"></i>
              <span>API 服务运行正常</span>
            </div>
          </div>
        </div>

        <!-- Knowledge Base -->
        <div id="knowledge" class="tab-content">
          <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">知识库管理</h1>
            <button
              onclick="showKnowledgeModal()"
              class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition"
            >
              <i class="fas fa-plus mr-2"></i>添加知识
            </button>
          </div>
          <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    标题
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    关键词
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    分类
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    状态
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    操作
                  </th>
                </tr>
              </thead>
              <tbody
                id="knowledgeTable"
                class="divide-y divide-gray-200"
              ></tbody>
            </table>
          </div>
        </div>

        <!-- Blacklist -->
        <div id="blacklist" class="tab-content">
          <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">黑名单管理</h1>
            <button
              onclick="showBlacklistModal()"
              class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition"
            >
              <i class="fas fa-plus mr-2"></i>添加黑名单
            </button>
          </div>
          <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    Discord ID
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    用户名
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    原因
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    类型
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    操作
                  </th>
                </tr>
              </thead>
              <tbody
                id="blacklistTable"
                class="divide-y divide-gray-200"
              ></tbody>
            </table>
          </div>
        </div>

        <!-- Channels -->
        <div id="channels" class="tab-content">
          <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">频道白名单</h1>
            <button
              onclick="showChannelModal()"
              class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition"
            >
              <i class="fas fa-plus mr-2"></i>添加频道
            </button>
          </div>
          <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    频道ID
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    频道名
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    服务器ID
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    操作
                  </th>
                </tr>
              </thead>
              <tbody
                id="channelsTable"
                class="divide-y divide-gray-200"
              ></tbody>
            </table>
          </div>
        </div>

        <!-- Memories -->
        <div id="memories" class="tab-content">
          <h1 class="text-3xl font-bold text-gray-800 mb-6">用户记忆</h1>
          <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    用户ID
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    记忆摘要
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    更新时间
                  </th>
                </tr>
              </thead>
              <tbody
                id="memoriesTable"
                class="divide-y divide-gray-200"
              ></tbody>
            </table>
          </div>
        </div>

        <!-- LLM Config -->
        <div id="llmconfig" class="tab-content">
          <h1 class="text-3xl font-bold text-gray-800 mb-6">API设置</h1>
          <div class="bg-white rounded-xl shadow-sm p-6">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                  >API地址</label
                >
                <input
                  type="text"
                  id="llmBaseUrl"
                  placeholder="https://api.openai.com/v1"
                  class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                  >API密钥</label
                >
                <input
                  type="password"
                  id="llmApiKey"
                  placeholder="sk-..."
                  class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                  >模型名称</label
                >
                <div class="flex space-x-2">
                  <select
                    id="llmModel"
                    class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  >
                    <option value="">请选择或手动输入</option>
                  </select>
                  <input
                    type="text"
                    id="llmModelCustom"
                    placeholder="或手动输入模型名"
                    class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  />
                  <button
                    onclick="fetchModels()"
                    class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition"
                  >
                    <i class="fas fa-sync-alt mr-1"></i>拉取
                  </button>
                </div>
                <p id="modelStatus" class="text-sm text-gray-500 mt-1"></p>
              </div>
              <button
                onclick="saveLLMConfig()"
                class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition"
              >
                <i class="fas fa-save mr-2"></i>保存
              </button>
            </div>
          </div>
        </div>

        <!-- Bot Config -->
        <div id="botconfig" class="tab-content">
          <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Bot设置</h1>
            <button
              onclick="showBotConfigModal()"
              class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition"
            >
              <i class="fas fa-plus mr-2"></i>添加Bot
            </button>
          </div>
          <div id="botConfigList" class="space-y-4"></div>
        </div>

        <!-- Sensitive Words -->
        <div id="sensitive" class="tab-content">
          <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">敏感词管理</h1>
            <button
              onclick="showSensitiveModal()"
              class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition"
            >
              <i class="fas fa-plus mr-2"></i>添加敏感词
            </button>
          </div>
          <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    敏感词
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    分类
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    状态
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    操作
                  </th>
                </tr>
              </thead>
              <tbody
                id="sensitiveTable"
                class="divide-y divide-gray-200"
              ></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Knowledge Modal -->
    <div
      id="knowledgeModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white rounded-lg p-6 w-[600px] max-h-[80vh] overflow-y-auto"
      >
        <h2 class="text-xl font-bold mb-4">添加知识</h2>
        <input
          type="text"
          id="kbTitle"
          placeholder="标题"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <textarea
          id="kbContent"
          placeholder="内容"
          rows="6"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        ></textarea>
        <input
          type="text"
          id="kbKeywords"
          placeholder="关键词（逗号分隔）"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <input
          type="text"
          id="kbCategory"
          placeholder="分类"
          class="w-full px-4 py-2 border rounded-lg mb-4"
        />
        <div class="flex justify-end space-x-3">
          <button
            onclick="hideKnowledgeModal()"
            class="px-4 py-2 border rounded-lg hover:bg-gray-100"
          >
            取消
          </button>
          <button
            onclick="addKnowledge()"
            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
          >
            保存
          </button>
        </div>
      </div>
    </div>

    <!-- Blacklist Modal -->
    <div
      id="blacklistModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div class="bg-white rounded-lg p-6 w-96">
        <h2 class="text-xl font-bold mb-4">添加黑名单</h2>
        <input
          type="text"
          id="blDiscordId"
          placeholder="Discord ID"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <input
          type="text"
          id="blUsername"
          placeholder="用户名（可选）"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <input
          type="text"
          id="blReason"
          placeholder="原因（可选）"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <label class="flex items-center mb-3">
          <input
            type="checkbox"
            id="blPermanent"
            class="mr-2"
            onchange="toggleDuration()"
          />
          <span>永久拉黑</span>
        </label>
        <input
          type="number"
          id="blDuration"
          placeholder="时长（分钟）"
          class="w-full px-4 py-2 border rounded-lg mb-4"
        />
        <div class="flex justify-end space-x-3">
          <button
            onclick="hideBlacklistModal()"
            class="px-4 py-2 border rounded-lg hover:bg-gray-100"
          >
            取消
          </button>
          <button
            onclick="addBlacklist()"
            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
          >
            添加
          </button>
        </div>
      </div>
    </div>

    <!-- Channel Modal -->
    <div
      id="channelModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div class="bg-white rounded-lg p-6 w-96">
        <h2 class="text-xl font-bold mb-4">添加频道</h2>
        <input
          type="text"
          id="chChannelId"
          placeholder="频道ID"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <input
          type="text"
          id="chGuildId"
          placeholder="服务器ID"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <input
          type="text"
          id="chName"
          placeholder="频道名（可选）"
          class="w-full px-4 py-2 border rounded-lg mb-4"
        />
        <div class="flex justify-end space-x-3">
          <button
            onclick="hideChannelModal()"
            class="px-4 py-2 border rounded-lg hover:bg-gray-100"
          >
            取消
          </button>
          <button
            onclick="addChannel()"
            class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
          >
            添加
          </button>
        </div>
      </div>
    </div>

    <!-- Bot Config Modal -->
    <div
      id="botConfigModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white rounded-lg p-6 w-[600px] max-h-[80vh] overflow-y-auto"
      >
        <h2 class="text-xl font-bold mb-4">Bot配置</h2>
        <input
          type="text"
          id="bcBotId"
          placeholder="Bot ID（如：default）"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <input
          type="text"
          id="bcBotName"
          placeholder="Bot名称"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <textarea
          id="bcSystemPrompt"
          placeholder="人设（System Prompt）"
          rows="8"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        ></textarea>
        <input
          type="number"
          id="bcContextLimit"
          placeholder="上下文条数（默认10）"
          class="w-full px-4 py-2 border rounded-lg mb-4"
        />
        <div class="flex justify-end space-x-3">
          <button
            onclick="hideBotConfigModal()"
            class="px-4 py-2 border rounded-lg hover:bg-gray-100"
          >
            取消
          </button>
          <button
            onclick="saveBotConfig()"
            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
          >
            保存
          </button>
        </div>
      </div>
    </div>

    <!-- Sensitive Word Modal -->
    <div
      id="sensitiveModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div class="bg-white rounded-lg p-6 w-96">
        <h2 class="text-xl font-bold mb-4">添加敏感词</h2>
        <input
          type="text"
          id="swWord"
          placeholder="敏感词"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <input
          type="text"
          id="swCategory"
          placeholder="分类（可选）"
          class="w-full px-4 py-2 border rounded-lg mb-4"
        />
        <div class="flex justify-end space-x-3">
          <button
            onclick="hideSensitiveModal()"
            class="px-4 py-2 border rounded-lg hover:bg-gray-100"
          >
            取消
          </button>
          <button
            onclick="addSensitiveWord()"
            class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700"
          >
            添加
          </button>
        </div>
      </div>
    </div>

    <script>
      let adminSecret = "";
      const API_BASE = "";

      async function api(endpoint, method = "GET", body = null) {
        const options = {
          method,
          headers: {
            "Content-Type": "application/json",
            "X-Admin-Secret": adminSecret,
          },
        };
        if (body) options.body = JSON.stringify(body);
        const resp = await fetch(API_BASE + endpoint, options);
        if (!resp.ok) throw new Error("API Error");
        return resp.json();
      }

      async function login() {
        adminSecret = document.getElementById("adminSecret").value;
        try {
          await api("/api/admin/blacklist");
          document.getElementById("loginModal").classList.add("hidden");
          document.getElementById("mainContent").classList.remove("hidden");
          loadDashboard();
        } catch {
          document.getElementById("loginError").classList.remove("hidden");
        }
      }

      function showTab(tabId) {
        document
          .querySelectorAll(".tab-content")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".sidebar-item")
          .forEach((s) => s.classList.remove("active"));
        document.getElementById(tabId).classList.add("active");
        event.target.closest(".sidebar-item").classList.add("active");

        switch (tabId) {
          case "dashboard":
            loadDashboard();
            break;
          case "knowledge":
            loadKnowledge();
            break;
          case "blacklist":
            loadBlacklist();
            break;
          case "channels":
            loadChannels();
            break;
          case "memories":
            loadMemories();
            break;
          case "sensitive":
            loadSensitiveWords();
            break;
        }
      }

      async function loadDashboard() {
        try {
          const [users, knowledge, blacklist, channels] = await Promise.all([
            api("/api/admin/users"),
            api("/api/knowledge/"),
            api("/api/admin/blacklist"),
            api("/api/admin/channels"),
          ]);
          document.getElementById("statUsers").textContent = users.length;
          document.getElementById("statKnowledge").textContent =
            knowledge.length;
          document.getElementById("statBlacklist").textContent =
            blacklist.length;
          document.getElementById("statChannels").textContent = channels.length;
        } catch (e) {
          console.error(e);
        }
      }

      async function loadKnowledge() {
        const data = await api("/api/knowledge/");
        document.getElementById("knowledgeTable").innerHTML = data
          .map(
            (kb) => `
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-900">${kb.title}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${
                      kb.keywords || "-"
                    }</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${
                      kb.category || "-"
                    }</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs rounded-full ${
                          kb.is_active
                            ? "bg-green-100 text-green-800"
                            : "bg-gray-100 text-gray-800"
                        }">
                            ${kb.is_active ? "启用" : "禁用"}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="deleteKnowledge(${
                          kb.id
                        })" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      async function loadBlacklist() {
        const data = await api("/api/admin/blacklist");
        document.getElementById("blacklistTable").innerHTML = data
          .map(
            (bl) => `
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-900">${
                      bl.discord_id
                    }</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${
                      bl.username || "-"
                    }</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${
                      bl.reason || "-"
                    }</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs rounded-full ${
                          bl.is_permanent
                            ? "bg-red-100 text-red-800"
                            : "bg-yellow-100 text-yellow-800"
                        }">
                            ${bl.is_permanent ? "永久" : "限时"}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="removeBlacklist('${
                          bl.discord_id
                        }')" class="text-green-600 hover:text-green-800">
                            <i class="fas fa-unlock"></i>
                        </button>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      async function loadChannels() {
        const data = await api("/api/admin/channels");
        document.getElementById("channelsTable").innerHTML = data
          .map(
            (ch) => `
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-900">${
                      ch.channel_id
                    }</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${
                      ch.channel_name || "-"
                    }</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${
                      ch.guild_id
                    }</td>
                    <td class="px-6 py-4">
                        <button onclick="removeChannel('${
                          ch.channel_id
                        }')" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      async function loadMemories() {
        const data = await api("/api/admin/memories");
        document.getElementById("memoriesTable").innerHTML = data
          .map(
            (m) => `
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-900">${
                      m.user_id
                    }</td>
                    <td class="px-6 py-4 text-sm text-gray-500 max-w-md truncate">${
                      m.summary || "-"
                    }</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${new Date(
                      m.updated_at
                    ).toLocaleString()}</td>
                </tr>
            `
          )
          .join("");
      }

      async function loadSensitiveWords() {
        const data = await api("/api/admin/sensitive-words");
        document.getElementById("sensitiveTable").innerHTML = data
          .map(
            (sw) => `
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-900">${sw.word}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${
                      sw.category || "-"
                    }</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs rounded-full ${
                          sw.is_active
                            ? "bg-green-100 text-green-800"
                            : "bg-gray-100 text-gray-800"
                        }">
                            ${sw.is_active ? "启用" : "禁用"}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="removeSensitiveWord(${
                          sw.id
                        })" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      // Modal functions
      function showKnowledgeModal() {
        document.getElementById("knowledgeModal").classList.remove("hidden");
      }
      function hideKnowledgeModal() {
        document.getElementById("knowledgeModal").classList.add("hidden");
      }
      function showBlacklistModal() {
        document.getElementById("blacklistModal").classList.remove("hidden");
      }
      function hideBlacklistModal() {
        document.getElementById("blacklistModal").classList.add("hidden");
      }
      function showChannelModal() {
        document.getElementById("channelModal").classList.remove("hidden");
      }
      function hideChannelModal() {
        document.getElementById("channelModal").classList.add("hidden");
      }
      function showSensitiveModal() {
        document.getElementById("sensitiveModal").classList.remove("hidden");
      }
      function hideSensitiveModal() {
        document.getElementById("sensitiveModal").classList.add("hidden");
      }

      function toggleDuration() {
        document.getElementById("blDuration").disabled =
          document.getElementById("blPermanent").checked;
      }

      // CRUD operations
      async function addKnowledge() {
        await api("/api/knowledge/", "POST", {
          title: document.getElementById("kbTitle").value,
          content: document.getElementById("kbContent").value,
          keywords: document.getElementById("kbKeywords").value,
          category: document.getElementById("kbCategory").value,
        });
        hideKnowledgeModal();
        loadKnowledge();
      }

      async function deleteKnowledge(id) {
        if (confirm("确定删除？")) {
          await api(`/api/knowledge/${id}`, "DELETE");
          loadKnowledge();
        }
      }

      async function addBlacklist() {
        await api("/api/admin/blacklist", "POST", {
          discord_id: document.getElementById("blDiscordId").value,
          username: document.getElementById("blUsername").value,
          reason: document.getElementById("blReason").value,
          is_permanent: document.getElementById("blPermanent").checked,
          duration_minutes:
            parseInt(document.getElementById("blDuration").value) || null,
        });
        hideBlacklistModal();
        loadBlacklist();
      }

      async function removeBlacklist(discordId) {
        if (confirm("确定解禁？")) {
          await api(`/api/admin/blacklist/${discordId}`, "DELETE");
          loadBlacklist();
        }
      }

      async function addChannel() {
        await api("/api/admin/channels", "POST", {
          channel_id: document.getElementById("chChannelId").value,
          guild_id: document.getElementById("chGuildId").value,
          channel_name: document.getElementById("chName").value,
        });
        hideChannelModal();
        loadChannels();
      }

      async function removeChannel(channelId) {
        if (confirm("确定移除？")) {
          await api(`/api/admin/channels/${channelId}`, "DELETE");
          loadChannels();
        }
      }

      async function addSensitiveWord() {
        await api("/api/admin/sensitive-words", "POST", {
          word: document.getElementById("swWord").value,
          category: document.getElementById("swCategory").value,
        });
        hideSensitiveModal();
        loadSensitiveWords();
      }

      async function removeSensitiveWord(id) {
        if (confirm("确定删除？")) {
          await api(`/api/admin/sensitive-words/${id}`, "DELETE");
          loadSensitiveWords();
        }
      }

      // LLM Config
      async function loadLLMConfig() {
        try {
          const config = await api("/api/admin/llm-config");
          document.getElementById("llmBaseUrl").value = config.base_url || "";
          document.getElementById("llmApiKey").value = config.api_key
            ? "********"
            : "";
          document.getElementById("llmModel").value = config.model || "";
        } catch (e) {
          console.error(e);
        }
      }

      async function saveLLMConfig() {
        const apiKey = document.getElementById("llmApiKey").value;
        const modelSelect = document.getElementById("llmModel").value;
        const modelCustom = document.getElementById("llmModelCustom").value;
        const model = modelCustom || modelSelect;

        const data = {
          base_url: document.getElementById("llmBaseUrl").value,
          model: model,
        };
        if (apiKey && apiKey !== "********") {
          data.api_key = apiKey;
        }
        await api("/api/admin/llm-config", "PUT", data);
        alert("保存成功！");
      }

      async function fetchModels() {
        const status = document.getElementById("modelStatus");
        status.textContent = "正在获取模型列表...";
        status.className = "text-sm text-blue-500 mt-1";

        try {
          const result = await api("/api/admin/llm-models");
          const select = document.getElementById("llmModel");
          select.innerHTML = '<option value="">请选择模型</option>';

          for (const model of result.models) {
            const option = document.createElement("option");
            option.value = model;
            option.textContent = model;
            select.appendChild(option);
          }

          status.textContent = `成功获取 ${result.models.length} 个模型`;
          status.className = "text-sm text-green-500 mt-1";
        } catch (e) {
          status.textContent = "获取失败：" + (e.message || "请检查API配置");
          status.className = "text-sm text-red-500 mt-1";
        }
      }

      // Bot Config
      async function loadBotConfigs() {
        try {
          const configs = await api("/api/admin/bot-config");
          document.getElementById("botConfigList").innerHTML =
            configs.length === 0
              ? '<div class="bg-white rounded-xl p-6 shadow-sm text-gray-500">暂无Bot配置，点击右上角添加</div>'
              : configs
                  .map(
                    (bc) => `
              <div class="bg-white rounded-xl p-6 shadow-sm">
                <div class="flex justify-between items-start">
                  <div>
                    <h3 class="text-lg font-bold text-gray-800">${
                      bc.bot_name || bc.bot_id
                    }</h3>
                    <p class="text-sm text-gray-500">ID: ${bc.bot_id}</p>
                  </div>
                  <div class="flex space-x-2">
                    <button onclick="editBotConfig('${
                      bc.bot_id
                    }')" class="text-indigo-600 hover:text-indigo-800">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteBotConfig('${
                      bc.bot_id
                    }')" class="text-red-600 hover:text-red-800">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
                <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
                  <div><span class="text-gray-500">上下文条数：</span>${
                    bc.context_limit
                  }</div>
                  <div><span class="text-gray-500">状态：</span>${
                    bc.is_active ? "启用" : "禁用"
                  }</div>
                </div>
                <div class="mt-3 text-sm text-gray-600 truncate">
                  <span class="text-gray-500">人设：</span>${(
                    bc.system_prompt || ""
                  ).substring(0, 100)}...
                </div>
              </div>
            `
                  )
                  .join("");
        } catch (e) {
          console.error(e);
        }
      }

      let editingBotId = null;

      function showBotConfigModal() {
        editingBotId = null;
        document.getElementById("bcBotId").value = "";
        document.getElementById("bcBotId").disabled = false;
        document.getElementById("bcBotName").value = "";
        document.getElementById("bcSystemPrompt").value = "";
        document.getElementById("bcContextLimit").value = "10";
        document.getElementById("botConfigModal").classList.remove("hidden");
      }

      function hideBotConfigModal() {
        document.getElementById("botConfigModal").classList.add("hidden");
      }

      async function editBotConfig(botId) {
        editingBotId = botId;
        const config = await api(`/api/admin/bot-config/${botId}`);
        document.getElementById("bcBotId").value = config.bot_id;
        document.getElementById("bcBotId").disabled = true;
        document.getElementById("bcBotName").value = config.bot_name || "";
        document.getElementById("bcSystemPrompt").value =
          config.system_prompt || "";
        document.getElementById("bcContextLimit").value =
          config.context_limit || 10;
        document.getElementById("botConfigModal").classList.remove("hidden");
      }

      async function saveBotConfig() {
        const botId = editingBotId || document.getElementById("bcBotId").value;
        const data = {
          bot_id: botId,
          bot_name: document.getElementById("bcBotName").value,
          system_prompt: document.getElementById("bcSystemPrompt").value,
          context_limit:
            parseInt(document.getElementById("bcContextLimit").value) || 10,
        };

        if (editingBotId) {
          await api(`/api/admin/bot-config/${botId}`, "PUT", data);
        } else {
          await api("/api/admin/bot-config", "POST", data);
        }
        hideBotConfigModal();
        loadBotConfigs();
      }

      async function deleteBotConfig(botId) {
        if (confirm("确定删除此Bot配置？")) {
          await api(`/api/admin/bot-config/${botId}`, "DELETE");
          loadBotConfigs();
        }
      }

      // Update showTab to handle new tabs
      const originalShowTab = showTab;
      showTab = function (tabId) {
        document
          .querySelectorAll(".tab-content")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".sidebar-item")
          .forEach((s) => s.classList.remove("active"));
        document.getElementById(tabId).classList.add("active");
        event.target.closest(".sidebar-item").classList.add("active");

        switch (tabId) {
          case "dashboard":
            loadDashboard();
            break;
          case "knowledge":
            loadKnowledge();
            break;
          case "blacklist":
            loadBlacklist();
            break;
          case "channels":
            loadChannels();
            break;
          case "memories":
            loadMemories();
            break;
          case "sensitive":
            loadSensitiveWords();
            break;
          case "llmconfig":
            loadLLMConfig();
            break;
          case "botconfig":
            loadBotConfigs();
            break;
        }
      };

      // Enter key login
      document
        .getElementById("adminSecret")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter") login();
        });
    </script>
  </body>
</html>
