<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CatieBot 管理后台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .sidebar-item.active {
        background-color: rgb(79 70 229);
        color: white;
      }
      /* Toast 通知样式 */
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .toast {
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 12px;
        animation: slideIn 0.3s ease-out;
        max-width: 400px;
        backdrop-filter: blur(10px);
      }
      .toast.success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
      }
      .toast.error {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
      }
      .toast.info {
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        color: white;
      }
      .toast i {
        font-size: 20px;
      }
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Login Modal -->
    <div
      id="loginModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    >
      <div class="bg-white rounded-lg p-8 w-96 shadow-xl">
        <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">
          <i class="fas fa-robot mr-2"></i>CatieBot 管理
        </h2>
        <input
          type="password"
          id="adminSecret"
          placeholder="输入管理密码"
          class="w-full px-4 py-3 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500"
        />
        <button
          onclick="login()"
          class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition"
        >
          登录
        </button>
        <p id="loginError" class="text-red-500 text-center mt-3 hidden">
          密码错误
        </p>
      </div>
    </div>

    <!-- Main Layout -->
    <div id="mainContent" class="hidden flex">
      <!-- Sidebar -->
      <div class="w-64 bg-gray-900 min-h-screen p-4">
        <div class="text-white text-xl font-bold mb-8 flex items-center">
          <i class="fas fa-robot mr-3"></i>CatieBot
        </div>
        <nav class="space-y-2">
          <a
            href="#"
            onclick="showTab('dashboard')"
            class="sidebar-item active flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 transition"
          >
            <i class="fas fa-tachometer-alt mr-3"></i>仪表盘
          </a>
          <a
            href="#"
            onclick="showTab('knowledge')"
            class="sidebar-item flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 transition"
          >
            <i class="fas fa-book mr-3"></i>知识库
          </a>
          <a
            href="#"
            onclick="showTab('blacklist')"
            class="sidebar-item flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 transition"
          >
            <i class="fas fa-ban mr-3"></i>黑名单
          </a>
          <a
            href="#"
            onclick="showTab('channels')"
            class="sidebar-item flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 transition"
          >
            <i class="fas fa-hashtag mr-3"></i>频道白名单
          </a>
          <a
            href="#"
            onclick="showTab('memories')"
            class="sidebar-item flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 transition"
          >
            <i class="fas fa-brain mr-3"></i>用户记忆
          </a>
          <a
            href="#"
            onclick="showTab('sensitive')"
            class="sidebar-item flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 transition"
          >
            <i class="fas fa-shield-alt mr-3"></i>敏感词
          </a>
          <div class="border-t border-gray-700 my-4"></div>
          <a
            href="#"
            onclick="showTab('llmconfig')"
            class="sidebar-item flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 transition"
          >
            <i class="fas fa-cog mr-3"></i>API设置
          </a>
          <a
            href="#"
            onclick="showTab('llmpool')"
            class="sidebar-item flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 transition"
          >
            <i class="fas fa-layer-group mr-3"></i>模型池
          </a>
          <a
            href="#"
            onclick="showTab('botconfig')"
            class="sidebar-item flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 transition"
          >
            <i class="fas fa-robot mr-3"></i>Bot设置
          </a>
        </nav>
      </div>

      <!-- Content -->
      <div class="flex-1 p-8">
        <!-- Dashboard -->
        <div id="dashboard" class="tab-content active">
          <h1 class="text-3xl font-bold text-gray-800 mb-6">仪表盘</h1>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl p-6 shadow-sm">
              <div class="flex items-center">
                <div class="p-3 bg-blue-100 rounded-lg">
                  <i class="fas fa-users text-blue-600 text-xl"></i>
                </div>
                <div class="ml-4">
                  <p class="text-gray-500 text-sm">用户数</p>
                  <p id="statUsers" class="text-2xl font-bold text-gray-800">
                    -
                  </p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-sm">
              <div class="flex items-center">
                <div class="p-3 bg-green-100 rounded-lg">
                  <i class="fas fa-book text-green-600 text-xl"></i>
                </div>
                <div class="ml-4">
                  <p class="text-gray-500 text-sm">知识条目</p>
                  <p
                    id="statKnowledge"
                    class="text-2xl font-bold text-gray-800"
                  >
                    -
                  </p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-sm">
              <div class="flex items-center">
                <div class="p-3 bg-red-100 rounded-lg">
                  <i class="fas fa-ban text-red-600 text-xl"></i>
                </div>
                <div class="ml-4">
                  <p class="text-gray-500 text-sm">黑名单</p>
                  <p
                    id="statBlacklist"
                    class="text-2xl font-bold text-gray-800"
                  >
                    -
                  </p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-sm">
              <div class="flex items-center">
                <div class="p-3 bg-purple-100 rounded-lg">
                  <i class="fas fa-hashtag text-purple-600 text-xl"></i>
                </div>
                <div class="ml-4">
                  <p class="text-gray-500 text-sm">白名单频道</p>
                  <p id="statChannels" class="text-2xl font-bold text-gray-800">
                    -
                  </p>
                </div>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl p-6 shadow-sm">
            <h2 class="text-xl font-bold text-gray-800 mb-4">系统状态</h2>
            <div class="flex items-center text-green-600">
              <i class="fas fa-check-circle mr-2"></i>
              <span>API 服务运行正常</span>
            </div>
          </div>
        </div>

        <!-- Knowledge Base -->
        <div id="knowledge" class="tab-content">
          <div class="flex justify-between items-center mb-6">
            <div>
              <h1 class="text-3xl font-bold text-gray-800">知识库管理</h1>
              <p id="knowledgeCount" class="text-sm text-gray-500 mt-1">
                共 0 条知识
              </p>
            </div>
            <div class="flex space-x-2">
              <button
                onclick="rebuildKnowledgeEmbeddings()"
                class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition"
              >
                <i class="fas fa-sync-alt mr-2"></i>重建向量
              </button>
              <button
                onclick="showImportModal()"
                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition"
              >
                <i class="fas fa-file-import mr-2"></i>批量导入
              </button>
              <button
                onclick="showKnowledgeModal()"
                class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition"
              >
                <i class="fas fa-plus mr-2"></i>添加知识
              </button>
            </div>
          </div>
          <!-- 批量操作栏 -->
          <div
            id="knowledgeBatchBar"
            class="hidden bg-indigo-50 border border-indigo-200 rounded-lg p-3 mb-4 flex items-center justify-between"
          >
            <span class="text-sm text-indigo-700"
              >已选择 <strong id="kbSelectedCount">0</strong> 条知识</span
            >
            <div class="flex space-x-2">
              <input
                type="text"
                id="kbBatchCategoryInput"
                placeholder="输入分类名"
                class="px-3 py-1 border rounded text-sm w-32"
              />
              <button
                onclick="kbBatchSetCategory()"
                class="bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700"
              >
                <i class="fas fa-folder mr-1"></i>设置分类
              </button>
              <button
                onclick="kbBatchToggleActive(true)"
                class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700"
              >
                <i class="fas fa-check mr-1"></i>启用
              </button>
              <button
                onclick="kbBatchToggleActive(false)"
                class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700"
              >
                <i class="fas fa-ban mr-1"></i>禁用
              </button>
              <button
                onclick="kbBatchDelete()"
                class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700"
              >
                <i class="fas fa-trash mr-1"></i>删除
              </button>
              <button
                onclick="clearKbSelection()"
                class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600"
              >
                取消
              </button>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left">
                    <input
                      type="checkbox"
                      id="kbSelectAll"
                      onchange="toggleSelectAllKb()"
                      class="w-4 h-4"
                    />
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    标题
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    关键词
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    分类
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    状态
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    操作
                  </th>
                </tr>
              </thead>
              <tbody
                id="knowledgeTable"
                class="divide-y divide-gray-200"
              ></tbody>
            </table>
            <!-- 分页 -->
            <div
              id="knowledgePagination"
              class="flex items-center justify-between px-6 py-3 bg-gray-50 border-t"
            >
              <div class="text-sm text-gray-500">
                显示 <span id="kbShowingStart">0</span>-<span id="kbShowingEnd"
                  >0</span
                >
                / <span id="kbTotalItems">0</span> 条
              </div>
              <div class="flex space-x-2">
                <button
                  onclick="loadKnowledge(knowledgePage - 1)"
                  id="kbPrevBtn"
                  class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50"
                  disabled
                >
                  上一页
                </button>
                <span id="kbPageInfo" class="px-3 py-1 text-sm">第 1 页</span>
                <button
                  onclick="loadKnowledge(knowledgePage + 1)"
                  id="kbNextBtn"
                  class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50"
                  disabled
                >
                  下一页
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Blacklist -->
        <div id="blacklist" class="tab-content">
          <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">黑名单管理</h1>
            <button
              onclick="showBlacklistModal()"
              class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition"
            >
              <i class="fas fa-plus mr-2"></i>添加黑名单
            </button>
          </div>
          <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    Discord ID
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    用户名
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    原因
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    类型
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    操作
                  </th>
                </tr>
              </thead>
              <tbody
                id="blacklistTable"
                class="divide-y divide-gray-200"
              ></tbody>
            </table>
          </div>
        </div>

        <!-- Channels -->
        <div id="channels" class="tab-content">
          <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">频道白名单</h1>
            <button
              onclick="showChannelModal()"
              class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition"
            >
              <i class="fas fa-plus mr-2"></i>添加频道
            </button>
          </div>
          <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    频道ID
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    频道名
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    服务器ID
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    操作
                  </th>
                </tr>
              </thead>
              <tbody
                id="channelsTable"
                class="divide-y divide-gray-200"
              ></tbody>
            </table>
          </div>
        </div>

        <!-- Memories -->
        <div id="memories" class="tab-content">
          <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">用户记忆</h1>
            <div class="flex space-x-2">
              <select id="userSelect" class="px-4 py-2 border rounded-lg">
                <option value="">选择用户...</option>
              </select>
              <button
                onclick="summarizeUser()"
                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"
              >
                <i class="fas fa-brain mr-2"></i>汇总记忆
              </button>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    用户ID
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    记忆摘要
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    更新时间
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    操作
                  </th>
                </tr>
              </thead>
              <tbody
                id="memoriesTable"
                class="divide-y divide-gray-200"
              ></tbody>
            </table>
          </div>
        </div>

        <!-- Memory Edit Modal -->
        <div
          id="memoryModal"
          class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
        >
          <div
            class="bg-white rounded-lg p-6 w-[600px] max-h-[80vh] overflow-y-auto"
          >
            <h2 class="text-xl font-bold mb-4">编辑用户记忆</h2>
            <input type="hidden" id="memUserId" />
            <textarea
              id="memSummary"
              placeholder="记忆摘要"
              rows="10"
              class="w-full px-4 py-2 border rounded-lg mb-4"
            ></textarea>
            <div class="flex justify-end space-x-3">
              <button
                onclick="hideMemoryModal()"
                class="px-4 py-2 border rounded-lg hover:bg-gray-100"
              >
                取消
              </button>
              <button
                onclick="saveMemory()"
                class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
              >
                保存
              </button>
            </div>
          </div>
        </div>

        <!-- LLM Config -->
        <div id="llmconfig" class="tab-content">
          <h1 class="text-3xl font-bold text-gray-800 mb-6">API设置</h1>
          <div class="bg-white rounded-xl shadow-sm p-6">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                  >API地址</label
                >
                <input
                  type="text"
                  id="llmBaseUrl"
                  placeholder="https://api.openai.com/v1"
                  class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                  >API密钥</label
                >
                <input
                  type="password"
                  id="llmApiKey"
                  placeholder="sk-..."
                  class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                  >模型名称</label
                >
                <div class="flex space-x-2">
                  <select
                    id="llmModel"
                    class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    onchange="document.getElementById('llmModelCustom').value = this.value"
                  >
                    <option value="">请选择或手动输入</option>
                  </select>
                  <input
                    type="text"
                    id="llmModelCustom"
                    placeholder="或手动输入模型名"
                    class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  />
                  <button
                    onclick="fetchModels()"
                    class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition"
                  >
                    <i class="fas fa-sync-alt mr-1"></i>拉取
                  </button>
                </div>
                <p id="modelStatus" class="text-sm text-gray-500 mt-1"></p>
              </div>
              <div>
                <label class="flex items-center">
                  <input
                    type="checkbox"
                    id="llmStream"
                    class="mr-2 w-4 h-4"
                    checked
                  />
                  <span class="text-sm font-medium text-gray-700"
                    >启用流式传输</span
                  >
                </label>
                <p class="text-sm text-gray-500 mt-1">
                  开启后Bot回复会实时显示，关闭则等待完整回复
                </p>
              </div>
              <button
                onclick="saveLLMConfig()"
                class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition"
              >
                <i class="fas fa-save mr-2"></i>保存
              </button>
            </div>
          </div>

          <!-- Embedding Config -->
          <div class="bg-white rounded-xl shadow-sm p-6 mt-6">
            <h2 class="text-xl font-semibold mb-4">向量化服务 (Embedding)</h2>
            <p class="text-sm text-gray-500 mb-4">
              用于知识库语义搜索，留空则使用上方的LLM配置
            </p>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                  >API地址</label
                >
                <input
                  type="text"
                  id="embeddingBaseUrl"
                  placeholder="如：https://api.siliconflow.cn/v1"
                  class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                  >API密钥</label
                >
                <input
                  type="password"
                  id="embeddingApiKey"
                  placeholder="留空则使用LLM的密钥"
                  class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                  >模型名称</label
                >
                <div class="flex space-x-2">
                  <select
                    id="embeddingModel"
                    class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                  >
                    <option value="">请先拉取模型列表</option>
                  </select>
                  <input
                    type="text"
                    id="embeddingModelCustom"
                    placeholder="或手动输入模型名"
                    class="w-48 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                  />
                  <button
                    onclick="fetchEmbeddingModels()"
                    class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition"
                  >
                    <i class="fas fa-sync-alt mr-1"></i>拉取
                  </button>
                </div>
              </div>
              <p id="embeddingStatus" class="text-sm text-gray-500"></p>
              <div class="flex space-x-2">
                <button
                  onclick="testEmbeddingConnection()"
                  class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition"
                >
                  <i class="fas fa-plug mr-2"></i>测试连接
                </button>
                <button
                  onclick="saveEmbeddingConfig()"
                  class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition"
                >
                  <i class="fas fa-save mr-2"></i>保存向量配置
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- LLM Pool (模型池) -->
        <div id="llmpool" class="tab-content">
          <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">模型池 (负载均衡)</h1>
            <button
              onclick="showLLMPoolModal()"
              class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition"
            >
              <i class="fas fa-plus mr-2"></i>添加模型
            </button>
          </div>
          <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
              <div>
                <h3 class="font-medium text-gray-800">轮流调用说明</h3>
                <p class="text-sm text-gray-500">
                  添加多个模型后，系统会轮流使用它们处理请求，实现负载均衡
                </p>
              </div>
              <div id="poolStatus" class="text-sm"></div>
            </div>
            <div
              class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-blue-700"
            >
              <i class="fas fa-info-circle mr-2"></i>
              模型池为空时，将使用「API设置」中的默认配置
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    名称
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    API地址
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    模型
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    状态
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    操作
                  </th>
                </tr>
              </thead>
              <tbody id="llmPoolTable" class="divide-y divide-gray-200"></tbody>
            </table>
          </div>
        </div>

        <!-- Bot Config -->
        <div id="botconfig" class="tab-content">
          <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Bot设置</h1>
            <button
              onclick="showBotConfigModal()"
              class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition"
            >
              <i class="fas fa-plus mr-2"></i>添加Bot
            </button>
          </div>
          <div id="botConfigList" class="space-y-4"></div>
        </div>

        <!-- Sensitive Words -->
        <div id="sensitive" class="tab-content">
          <div class="flex justify-between items-center mb-6">
            <div>
              <h1 class="text-3xl font-bold text-gray-800">敏感词管理</h1>
              <p id="sensitiveCount" class="text-sm text-gray-500 mt-1">
                共 0 个敏感词
              </p>
            </div>
            <div class="flex space-x-2">
              <button
                onclick="clearAllSensitiveWords()"
                class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition"
              >
                <i class="fas fa-trash-alt mr-2"></i>清空全部
              </button>
              <button
                onclick="showSensitiveImportModal()"
                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition"
              >
                <i class="fas fa-file-import mr-2"></i>批量导入
              </button>
              <button
                onclick="showSensitiveModal()"
                class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition"
              >
                <i class="fas fa-plus mr-2"></i>添加敏感词
              </button>
            </div>
          </div>
          <!-- 批量操作栏 -->
          <div
            id="sensitiveBatchBar"
            class="hidden bg-orange-50 border border-orange-200 rounded-lg p-3 mb-4 flex items-center justify-between"
          >
            <span class="text-sm text-orange-700"
              >已选择
              <strong id="sensitiveSelectedCount">0</strong> 个敏感词</span
            >
            <div class="flex space-x-2">
              <input
                type="text"
                id="batchCategoryInput"
                placeholder="输入分类名"
                class="px-3 py-1 border rounded text-sm w-32"
              />
              <button
                onclick="batchSetCategory()"
                class="bg-orange-600 text-white px-3 py-1 rounded text-sm hover:bg-orange-700"
              >
                <i class="fas fa-folder mr-1"></i>设置分类
              </button>
              <button
                onclick="batchDeleteSensitive()"
                class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700"
              >
                <i class="fas fa-trash mr-1"></i>批量删除
              </button>
              <button
                onclick="clearSensitiveSelection()"
                class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600"
              >
                取消选择
              </button>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left">
                    <input
                      type="checkbox"
                      id="sensitiveSelectAll"
                      onchange="toggleSelectAllSensitive()"
                      class="w-4 h-4"
                    />
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    敏感词
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    分类
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    操作
                  </th>
                </tr>
              </thead>
              <tbody
                id="sensitiveTable"
                class="divide-y divide-gray-200"
              ></tbody>
            </table>
            <!-- 分页 -->
            <div
              class="flex items-center justify-between px-6 py-3 bg-gray-50 border-t"
            >
              <div class="text-sm text-gray-500">
                显示 <span id="swShowingStart">0</span>-<span id="swShowingEnd"
                  >0</span
                >
                / <span id="swTotalItems">0</span> 个
              </div>
              <div class="flex space-x-2">
                <button
                  onclick="loadSensitiveWords(sensitivePage - 1)"
                  id="swPrevBtn"
                  class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50"
                  disabled
                >
                  上一页
                </button>
                <span id="swPageInfo" class="px-3 py-1 text-sm">第 1 页</span>
                <button
                  onclick="loadSensitiveWords(sensitivePage + 1)"
                  id="swNextBtn"
                  class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50"
                  disabled
                >
                  下一页
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sensitive Import Modal -->
    <div
      id="sensitiveImportModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white rounded-lg p-6 w-[500px] max-h-[80vh] overflow-y-auto"
      >
        <h2 class="text-xl font-bold mb-4">批量导入敏感词</h2>
        <p class="text-sm text-gray-500 mb-3">每行一个敏感词</p>
        <div class="mb-3">
          <input
            type="file"
            id="sensitiveImportFile"
            accept=".txt"
            onchange="loadSensitiveFile()"
            class="text-sm"
          />
          <span class="text-xs text-gray-500 ml-2">或粘贴到下方</span>
        </div>
        <textarea
          id="sensitiveImportText"
          placeholder="每行一个敏感词..."
          rows="10"
          class="w-full px-4 py-2 border rounded-lg mb-3 font-mono text-sm"
        ></textarea>
        <input
          type="text"
          id="sensitiveImportCategory"
          placeholder="分类（可选）"
          class="w-full px-3 py-2 border rounded-lg mb-4"
        />
        <div
          id="sensitiveImportPreview"
          class="text-sm text-gray-500 mb-4"
        ></div>
        <div class="flex justify-end space-x-3">
          <button
            onclick="hideSensitiveImportModal()"
            class="px-4 py-2 border rounded-lg hover:bg-gray-100"
          >
            取消
          </button>
          <button
            onclick="doSensitiveImport()"
            class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700"
          >
            导入
          </button>
        </div>
      </div>
    </div>

    <!-- Import Modal -->
    <div
      id="importModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white rounded-lg p-6 w-[700px] max-h-[80vh] overflow-y-auto"
      >
        <h2 class="text-xl font-bold mb-4">批量导入知识</h2>
        <p class="text-sm text-gray-500 mb-3">
          支持用 <code>===</code> 分隔大块，<code>---</code>
          分隔小块，或每行一条
        </p>
        <div class="mb-3">
          <input
            type="file"
            id="importFile"
            accept=".txt,.md"
            onchange="loadImportFile()"
            class="text-sm"
          />
          <span class="text-xs text-gray-500 ml-2">或粘贴内容到下方</span>
        </div>
        <textarea
          id="importText"
          placeholder="粘贴知识内容..."
          rows="10"
          class="w-full px-4 py-2 border rounded-lg mb-3 font-mono text-sm"
        ></textarea>
        <div class="flex items-center mb-4">
          <label class="text-sm text-gray-700 mr-3">分隔符：</label>
          <select id="importSeparator" class="px-3 py-1 border rounded">
            <option value="===">===（大块）</option>
            <option value="---">---（小块）</option>
            <option value="\n\n">空行</option>
            <option value="\n">每行一条</option>
          </select>
          <input
            type="text"
            id="importCategory"
            placeholder="分类（可选）"
            class="ml-3 px-3 py-1 border rounded flex-1"
          />
        </div>
        <div id="importPreview" class="text-sm text-gray-500 mb-4"></div>
        <div class="flex justify-end space-x-3">
          <button
            onclick="hideImportModal()"
            class="px-4 py-2 border rounded-lg hover:bg-gray-100"
          >
            取消
          </button>
          <button
            onclick="previewImport()"
            class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700"
          >
            预览
          </button>
          <button
            onclick="doImport()"
            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
          >
            导入
          </button>
        </div>
      </div>
    </div>

    <!-- Knowledge Modal -->
    <div
      id="knowledgeModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white rounded-lg p-6 w-[600px] max-h-[80vh] overflow-y-auto"
      >
        <h2 class="text-xl font-bold mb-4">添加知识</h2>
        <input
          type="text"
          id="kbTitle"
          placeholder="标题"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <textarea
          id="kbContent"
          placeholder="内容"
          rows="6"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        ></textarea>
        <input
          type="text"
          id="kbKeywords"
          placeholder="关键词（逗号分隔）"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <input
          type="text"
          id="kbCategory"
          placeholder="分类"
          class="w-full px-4 py-2 border rounded-lg mb-4"
        />
        <div class="flex justify-end space-x-3">
          <button
            onclick="hideKnowledgeModal()"
            class="px-4 py-2 border rounded-lg hover:bg-gray-100"
          >
            取消
          </button>
          <button
            onclick="addKnowledge()"
            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
          >
            保存
          </button>
        </div>
      </div>
    </div>

    <!-- Blacklist Modal -->
    <div
      id="blacklistModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div class="bg-white rounded-lg p-6 w-96">
        <h2 class="text-xl font-bold mb-4">添加黑名单</h2>
        <input
          type="text"
          id="blDiscordId"
          placeholder="Discord ID"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <input
          type="text"
          id="blUsername"
          placeholder="用户名（可选）"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <input
          type="text"
          id="blReason"
          placeholder="原因（可选）"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <label class="flex items-center mb-3">
          <input
            type="checkbox"
            id="blPermanent"
            class="mr-2"
            onchange="toggleDuration()"
          />
          <span>永久拉黑</span>
        </label>
        <input
          type="number"
          id="blDuration"
          placeholder="时长（分钟）"
          class="w-full px-4 py-2 border rounded-lg mb-4"
        />
        <div class="flex justify-end space-x-3">
          <button
            onclick="hideBlacklistModal()"
            class="px-4 py-2 border rounded-lg hover:bg-gray-100"
          >
            取消
          </button>
          <button
            onclick="addBlacklist()"
            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
          >
            添加
          </button>
        </div>
      </div>
    </div>

    <!-- Channel Modal -->
    <div
      id="channelModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white rounded-lg p-6 w-[500px] max-h-[80vh] overflow-y-auto"
      >
        <h2 class="text-xl font-bold mb-4">添加频道</h2>

        <!-- 从Bot拉取频道 -->
        <div class="mb-4 p-3 bg-gray-50 rounded-lg">
          <div class="flex items-center space-x-2 mb-2">
            <input
              type="text"
              id="chBotId"
              placeholder="Bot ID（如：yu）"
              class="flex-1 px-3 py-2 border rounded-lg text-sm"
              value="yu"
            />
            <button
              onclick="fetchBotChannels()"
              class="bg-gray-600 text-white px-3 py-2 rounded-lg hover:bg-gray-700 text-sm"
            >
              <i class="fas fa-sync-alt mr-1"></i>拉取频道
            </button>
          </div>
          <div id="channelTree" class="max-h-60 overflow-y-auto text-sm"></div>
        </div>

        <div class="border-t pt-4">
          <p class="text-sm text-gray-500 mb-2">或手动输入：</p>
          <input
            type="text"
            id="chChannelId"
            placeholder="频道ID"
            class="w-full px-4 py-2 border rounded-lg mb-3"
          />
          <input
            type="text"
            id="chGuildId"
            placeholder="服务器ID"
            class="w-full px-4 py-2 border rounded-lg mb-3"
          />
          <input
            type="text"
            id="chName"
            placeholder="频道名（可选）"
            class="w-full px-4 py-2 border rounded-lg mb-4"
          />
        </div>
        <div class="flex justify-end space-x-3">
          <button
            onclick="hideChannelModal()"
            class="px-4 py-2 border rounded-lg hover:bg-gray-100"
          >
            取消
          </button>
          <button
            onclick="addChannel()"
            class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
          >
            添加
          </button>
        </div>
      </div>
    </div>

    <!-- Bot Config Modal -->
    <div
      id="botConfigModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white rounded-lg p-6 w-[600px] max-h-[80vh] overflow-y-auto"
      >
        <h2 class="text-xl font-bold mb-4">Bot配置</h2>
        <input
          type="text"
          id="bcBotId"
          placeholder="Bot ID（如：default）"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <input
          type="text"
          id="bcBotName"
          placeholder="Bot名称"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <textarea
          id="bcSystemPrompt"
          placeholder="人设（System Prompt）"
          rows="8"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        ></textarea>
        <input
          type="number"
          id="bcContextLimit"
          placeholder="上下文条数（默认10）"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <input
          type="text"
          id="bcAdminIds"
          placeholder="管理员ID（逗号分隔，如：123,456）"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <p class="text-sm text-gray-500 mb-3">
          管理员可使用Bot斜杠命令管理黑名单和频道白名单
        </p>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2"
            >对话模式</label
          >
          <div class="flex flex-col space-y-2">
            <label class="flex items-center">
              <input
                type="radio"
                name="chatMode"
                id="bcChatModeSingle"
                value="single"
                class="mr-2"
              />
              <span class="text-sm">单用户聊天（只看当前用户的历史）</span>
            </label>
            <label class="flex items-center">
              <input
                type="radio"
                name="chatMode"
                id="bcChatModeMulti"
                value="multi"
                checked
                class="mr-2"
              />
              <span class="text-sm">多用户聊天（看频道所有人的历史）</span>
            </label>
            <label class="flex items-center">
              <input
                type="radio"
                name="chatMode"
                id="bcChatModeQA"
                value="qa"
                class="mr-2"
              />
              <span class="text-sm">答疑模式（不看历史，只回答当前问题）</span>
            </label>
          </div>
        </div>
        <div class="flex justify-end space-x-3">
          <button
            onclick="hideBotConfigModal()"
            class="px-4 py-2 border rounded-lg hover:bg-gray-100"
          >
            取消
          </button>
          <button
            onclick="saveBotConfig()"
            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
          >
            保存
          </button>
        </div>
      </div>
    </div>

    <!-- Sensitive Word Modal -->
    <div
      id="sensitiveModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div class="bg-white rounded-lg p-6 w-96">
        <h2 class="text-xl font-bold mb-4">添加敏感词</h2>
        <input
          type="text"
          id="swWord"
          placeholder="敏感词"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <input
          type="text"
          id="swCategory"
          placeholder="分类（可选）"
          class="w-full px-4 py-2 border rounded-lg mb-4"
        />
        <div class="flex justify-end space-x-3">
          <button
            onclick="hideSensitiveModal()"
            class="px-4 py-2 border rounded-lg hover:bg-gray-100"
          >
            取消
          </button>
          <button
            onclick="addSensitiveWord()"
            class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700"
          >
            添加
          </button>
        </div>
      </div>
    </div>

    <!-- LLM Pool Modal -->
    <div
      id="llmPoolModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div class="bg-white rounded-lg p-6 w-[500px]">
        <h2 class="text-xl font-bold mb-4">添加模型到池</h2>
        <input
          type="text"
          id="poolName"
          placeholder="名称（如：硅基流动-DeepSeek）"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <input
          type="text"
          id="poolBaseUrl"
          placeholder="API地址（如：https://api.siliconflow.cn/v1）"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <input
          type="password"
          id="poolApiKey"
          placeholder="API密钥"
          class="w-full px-4 py-2 border rounded-lg mb-3"
        />
        <div class="flex space-x-2 mb-3">
          <select
            id="poolModelSelect"
            class="flex-1 px-4 py-2 border rounded-lg"
            onchange="document.getElementById('poolModel').value = this.value"
          >
            <option value="">选择或手动输入模型</option>
          </select>
          <button
            onclick="fetchPoolModels()"
            class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700"
          >
            <i class="fas fa-sync-alt"></i> 拉取
          </button>
        </div>
        <input
          type="text"
          id="poolModel"
          placeholder="模型名称（如：deepseek-ai/DeepSeek-V3）"
          class="w-full px-4 py-2 border rounded-lg mb-4"
        />
        <p id="poolModelStatus" class="text-sm text-gray-500 mb-3"></p>
        <div class="flex justify-between">
          <button
            onclick="testPoolConnection()"
            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
          >
            <i class="fas fa-plug mr-1"></i>测试连接
          </button>
          <div class="flex space-x-3">
            <button
              onclick="hideLLMPoolModal()"
              class="px-4 py-2 border rounded-lg hover:bg-gray-100"
            >
              取消
            </button>
            <button
              onclick="addToLLMPool()"
              class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
            >
              添加
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let adminSecret = "";
      const API_BASE = "";

      // Toast 通知函数
      function showToast(message, type = "info", duration = 3000) {
        const container = document.getElementById("toastContainer");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;

        const icons = {
          success: "fa-check-circle",
          error: "fa-times-circle",
          info: "fa-info-circle",
        };

        toast.innerHTML = `<i class="fas ${
          icons[type] || icons.info
        }"></i><span>${message}</span>`;
        container.appendChild(toast);

        setTimeout(() => {
          toast.style.animation = "slideOut 0.3s ease-out forwards";
          setTimeout(() => toast.remove(), 300);
        }, duration);
      }

      async function api(endpoint, method = "GET", body = null) {
        const options = {
          method,
          headers: {
            "Content-Type": "application/json",
            "X-Admin-Secret": adminSecret,
          },
        };
        if (body) options.body = JSON.stringify(body);
        const resp = await fetch(API_BASE + endpoint, options);
        if (!resp.ok) throw new Error("API Error");
        return resp.json();
      }

      async function login() {
        adminSecret = document.getElementById("adminSecret").value;
        try {
          await api("/api/admin/blacklist");
          document.getElementById("loginModal").classList.add("hidden");
          document.getElementById("mainContent").classList.remove("hidden");
          loadDashboard();
        } catch {
          document.getElementById("loginError").classList.remove("hidden");
        }
      }

      function showTab(tabId) {
        document
          .querySelectorAll(".tab-content")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".sidebar-item")
          .forEach((s) => s.classList.remove("active"));
        document.getElementById(tabId).classList.add("active");
        event.target.closest(".sidebar-item").classList.add("active");

        switch (tabId) {
          case "dashboard":
            loadDashboard();
            break;
          case "knowledge":
            loadKnowledge();
            break;
          case "blacklist":
            loadBlacklist();
            break;
          case "channels":
            loadChannels();
            break;
          case "memories":
            loadMemories();
            break;
          case "sensitive":
            loadSensitiveWords();
            break;
          case "llmpool":
            loadLLMPool();
            break;
        }
      }

      async function loadDashboard() {
        try {
          const [users, knowledge, blacklist, channels] = await Promise.all([
            api("/api/admin/users"),
            api("/api/admin/knowledge?limit=1"),
            api("/api/admin/blacklist"),
            api("/api/admin/channels"),
          ]);
          document.getElementById("statUsers").textContent = users.length;
          document.getElementById("statKnowledge").textContent =
            knowledge.total || 0;
          document.getElementById("statBlacklist").textContent =
            blacklist.length;
          document.getElementById("statChannels").textContent = channels.length;
        } catch (e) {
          console.error(e);
        }
      }

      let knowledgeData = [];
      let knowledgePage = 0;
      const knowledgePageSize = 20;
      let kbSelectedIds = new Set();

      async function loadKnowledge(page = 0) {
        if (page < 0) page = 0;
        knowledgePage = page;
        const skip = page * knowledgePageSize;

        try {
          const result = await api(
            `/api/admin/knowledge?skip=${skip}&limit=${knowledgePageSize}`
          );
          const data = result.items || [];
          const total = result.total || 0;
          knowledgeData = data;

          document.getElementById(
            "knowledgeCount"
          ).textContent = `共 ${total} 条知识`;

          const start = total > 0 ? skip + 1 : 0;
          const end = Math.min(skip + data.length, total);
          document.getElementById("kbShowingStart").textContent = start;
          document.getElementById("kbShowingEnd").textContent = end;
          document.getElementById("kbTotalItems").textContent = total;
          document.getElementById("kbPageInfo").textContent = `第 ${
            page + 1
          } 页`;

          document.getElementById("kbPrevBtn").disabled = page === 0;
          document.getElementById("kbNextBtn").disabled = end >= total;

          // 清空选择
          kbSelectedIds.clear();
          updateKbBatchBar();
          document.getElementById("kbSelectAll").checked = false;

          document.getElementById("knowledgeTable").innerHTML =
            data.length === 0
              ? '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">暂无知识条目</td></tr>'
              : data
                  .map(
                    (kb) => `
                <tr>
                    <td class="px-4 py-4"><input type="checkbox" class="kb-checkbox w-4 h-4" data-id="${
                      kb.id
                    }" onchange="toggleKbSelect(${kb.id})" /></td>
                    <td class="px-6 py-4 text-sm text-gray-900">${kb.title}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${
                      kb.keywords || "-"
                    }</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${
                      kb.category || "-"
                    }</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs rounded-full ${
                          kb.is_active
                            ? "bg-green-100 text-green-800"
                            : "bg-gray-100 text-gray-800"
                        }">${kb.is_active ? "启用" : "禁用"}</span>
                        ${
                          kb.has_embedding
                            ? '<span class="ml-1 px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">向量</span>'
                            : ""
                        }
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="editKnowledge(${
                          kb.id
                        })" class="text-indigo-600 hover:text-indigo-800 mr-2"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteKnowledge(${
                          kb.id
                        })" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `
                  )
                  .join("");
        } catch (e) {
          console.error("Load knowledge error:", e);
          showToast("加载知识库失败", "error");
        }
      }

      function toggleKbSelect(id) {
        if (kbSelectedIds.has(id)) kbSelectedIds.delete(id);
        else kbSelectedIds.add(id);
        updateKbBatchBar();
      }

      function toggleSelectAllKb() {
        const selectAll = document.getElementById("kbSelectAll").checked;
        document.querySelectorAll(".kb-checkbox").forEach((cb) => {
          cb.checked = selectAll;
          const id = parseInt(cb.dataset.id);
          if (selectAll) kbSelectedIds.add(id);
          else kbSelectedIds.delete(id);
        });
        updateKbBatchBar();
      }

      function updateKbBatchBar() {
        const count = kbSelectedIds.size;
        document.getElementById("kbSelectedCount").textContent = count;
        document
          .getElementById("knowledgeBatchBar")
          .classList.toggle("hidden", count === 0);
      }

      function clearKbSelection() {
        kbSelectedIds.clear();
        document
          .querySelectorAll(".kb-checkbox")
          .forEach((cb) => (cb.checked = false));
        document.getElementById("kbSelectAll").checked = false;
        updateKbBatchBar();
      }

      async function kbBatchSetCategory() {
        const category = document
          .getElementById("kbBatchCategoryInput")
          .value.trim();
        if (!category) {
          showToast("请输入分类名称", "error");
          return;
        }
        if (kbSelectedIds.size === 0) {
          showToast("请先选择知识条目", "error");
          return;
        }
        try {
          await api("/api/admin/knowledge/batch-category", "PUT", {
            ids: Array.from(kbSelectedIds),
            category,
          });
          showToast(
            `已将 ${kbSelectedIds.size} 条知识设为「${category}」`,
            "success"
          );
          clearKbSelection();
          loadKnowledge(knowledgePage);
        } catch (e) {
          showToast("批量设置分类失败: " + e.message, "error");
        }
      }

      async function kbBatchToggleActive(isActive) {
        if (kbSelectedIds.size === 0) {
          showToast("请先选择知识条目", "error");
          return;
        }
        try {
          await api("/api/admin/knowledge/batch-active", "PUT", {
            ids: Array.from(kbSelectedIds),
            is_active: isActive,
          });
          showToast(
            `已${isActive ? "启用" : "禁用"} ${kbSelectedIds.size} 条知识`,
            "success"
          );
          clearKbSelection();
          loadKnowledge(knowledgePage);
        } catch (e) {
          showToast("批量操作失败: " + e.message, "error");
        }
      }

      async function kbBatchDelete() {
        if (kbSelectedIds.size === 0) {
          showToast("请先选择知识条目", "error");
          return;
        }
        if (!confirm(`确定删除选中的 ${kbSelectedIds.size} 条知识？`)) return;
        try {
          await api("/api/admin/knowledge/batch-delete", "POST", {
            ids: Array.from(kbSelectedIds),
          });
          showToast(`已删除 ${kbSelectedIds.size} 条知识`, "success");
          clearKbSelection();
          loadKnowledge(knowledgePage);
        } catch (e) {
          showToast("批量删除失败: " + e.message, "error");
        }
      }

      async function loadBlacklist() {
        const data = await api("/api/admin/blacklist");
        document.getElementById("blacklistTable").innerHTML = data
          .map(
            (bl) => `
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-900">${
                      bl.discord_id
                    }</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${
                      bl.username || "-"
                    }</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${
                      bl.reason || "-"
                    }</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs rounded-full ${
                          bl.is_permanent
                            ? "bg-red-100 text-red-800"
                            : "bg-yellow-100 text-yellow-800"
                        }">
                            ${bl.is_permanent ? "永久" : "限时"}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="removeBlacklist('${
                          bl.discord_id
                        }')" class="text-green-600 hover:text-green-800">
                            <i class="fas fa-unlock"></i>
                        </button>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      async function loadChannels() {
        const data = await api("/api/admin/channels");
        document.getElementById("channelsTable").innerHTML = data
          .map(
            (ch) => `
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-900">${
                      ch.channel_id
                    }</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${
                      ch.channel_name || "-"
                    }</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${
                      ch.guild_id
                    }</td>
                    <td class="px-6 py-4">
                        <button onclick="removeChannel('${ch.bot_id}', '${
              ch.channel_id
            }')" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      async function loadMemories() {
        // 加载用户列表
        try {
          const users = await api("/api/admin/users");
          const userSelect = document.getElementById("userSelect");
          userSelect.innerHTML =
            '<option value="">选择用户...</option>' +
            users
              .map(
                (u) =>
                  `<option value="${u.discord_id}">${u.username} (${u.discord_id})</option>`
              )
              .join("");
        } catch (e) {}

        // 加载记忆列表
        const data = await api("/api/admin/memories");
        memoriesData = data;
        document.getElementById("memoriesTable").innerHTML =
          data.length === 0
            ? '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">暂无记忆，选择用户后点击"汇总记忆"生成</td></tr>'
            : data
                .map((m) => {
                  const safeId = m.user_id;
                  return `
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-900">${safeId}</td>
                    <td class="px-6 py-4 text-sm text-gray-500 max-w-md truncate" title="${(
                      m.summary || ""
                    ).replace(/"/g, "&quot;")}">${m.summary || "-"}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${new Date(
                      m.updated_at
                    ).toLocaleString()}</td>
                    <td class="px-6 py-4">
                        <button onclick="openMemoryEdit(${safeId})" class="text-indigo-600 hover:text-indigo-800 mr-2">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteMemory(${safeId})" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
                })
                .join("");
      }

      async function summarizeUser() {
        const discordId = document.getElementById("userSelect").value;
        if (!discordId) {
          showToast("请先选择用户", "error");
          return;
        }
        try {
          const btn = event.target;
          btn.disabled = true;
          btn.innerHTML =
            '<i class="fas fa-spinner fa-spin mr-2"></i>汇总中...';
          await api(`/api/admin/memories/summarize/${discordId}`, "POST");
          showToast("汇总成功！", "success");
          loadMemories();
        } catch (e) {
          showToast("汇总失败: " + e.message, "error");
        } finally {
          const btn = document.querySelector(
            'button[onclick="summarizeUser()"]'
          );
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-brain mr-2"></i>汇总记忆';
        }
      }

      let memoriesData = [];

      function openMemoryEdit(userId) {
        const mem = memoriesData.find((m) => m.user_id === userId);
        if (mem) {
          document.getElementById("memUserId").value = userId;
          document.getElementById("memSummary").value = mem.summary || "";
          document.getElementById("memoryModal").classList.remove("hidden");
        }
      }

      function editMemory(userId, summary) {
        document.getElementById("memUserId").value = userId;
        document.getElementById("memSummary").value = summary;
        document.getElementById("memoryModal").classList.remove("hidden");
      }

      function hideMemoryModal() {
        document.getElementById("memoryModal").classList.add("hidden");
      }

      async function saveMemory() {
        const userId = document.getElementById("memUserId").value;
        const summary = document.getElementById("memSummary").value;
        try {
          await api(`/api/admin/memories/${userId}`, "PUT", { summary });
          hideMemoryModal();
          loadMemories();
        } catch (e) {
          showToast("保存失败: " + e.message, "error");
        }
      }

      async function deleteMemory(userId) {
        if (confirm("确定删除此记忆？")) {
          await api(`/api/admin/memories/${userId}`, "DELETE");
          loadMemories();
        }
      }

      let sensitivePage = 0;
      const sensitivePageSize = 50;
      let sensitiveSelectedIds = new Set();

      async function loadSensitiveWords(page = 0) {
        if (page < 0) page = 0;
        sensitivePage = page;
        const skip = page * sensitivePageSize;

        try {
          const result = await api(
            `/api/admin/sensitive-words?skip=${skip}&limit=${sensitivePageSize}`
          );
          const data = result.items || [];
          const total = result.total || 0;

          document.getElementById(
            "sensitiveCount"
          ).textContent = `共 ${total} 个敏感词`;

          const start = total > 0 ? skip + 1 : 0;
          const end = Math.min(skip + data.length, total);
          document.getElementById("swShowingStart").textContent = start;
          document.getElementById("swShowingEnd").textContent = end;
          document.getElementById("swTotalItems").textContent = total;
          document.getElementById("swPageInfo").textContent = `第 ${
            page + 1
          } 页`;

          document.getElementById("swPrevBtn").disabled = page === 0;
          document.getElementById("swNextBtn").disabled = end >= total;

          sensitiveSelectedIds.clear();
          updateSensitiveBatchBar();
          document.getElementById("sensitiveSelectAll").checked = false;

          document.getElementById("sensitiveTable").innerHTML =
            data.length === 0
              ? '<tr><td colspan="4" class="px-6 py-8 text-center text-gray-500">暂无敏感词</td></tr>'
              : data
                  .map(
                    (sw) => `
                <tr>
                    <td class="px-4 py-4"><input type="checkbox" class="sensitive-checkbox w-4 h-4" data-id="${
                      sw.id
                    }" onchange="toggleSensitiveSelect(${sw.id})" /></td>
                    <td class="px-6 py-4 text-sm text-gray-900">${sw.word}</td>
                    <td class="px-6 py-4 text-sm text-gray-500"><span class="px-2 py-1 text-xs rounded-full ${
                      sw.category
                        ? "bg-orange-100 text-orange-800"
                        : "bg-gray-100 text-gray-600"
                    }">${sw.category || "无分类"}</span></td>
                    <td class="px-6 py-4"><button onclick="removeSensitiveWord(${
                      sw.id
                    })" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button></td>
                </tr>
            `
                  )
                  .join("");
        } catch (e) {
          console.error("Load sensitive words error:", e);
        }
      }

      function toggleSensitiveSelect(id) {
        if (sensitiveSelectedIds.has(id)) sensitiveSelectedIds.delete(id);
        else sensitiveSelectedIds.add(id);
        updateSensitiveBatchBar();
      }

      function toggleSelectAllSensitive() {
        const selectAll = document.getElementById("sensitiveSelectAll").checked;
        document.querySelectorAll(".sensitive-checkbox").forEach((cb) => {
          cb.checked = selectAll;
          const id = parseInt(cb.dataset.id);
          if (selectAll) sensitiveSelectedIds.add(id);
          else sensitiveSelectedIds.delete(id);
        });
        updateSensitiveBatchBar();
      }

      function updateSensitiveBatchBar() {
        const count = sensitiveSelectedIds.size;
        document.getElementById("sensitiveSelectedCount").textContent = count;
        document
          .getElementById("sensitiveBatchBar")
          .classList.toggle("hidden", count === 0);
      }

      function clearSensitiveSelection() {
        sensitiveSelectedIds.clear();
        document
          .querySelectorAll(".sensitive-checkbox")
          .forEach((cb) => (cb.checked = false));
        document.getElementById("sensitiveSelectAll").checked = false;
        updateSensitiveBatchBar();
      }

      async function batchSetCategory() {
        const category = document
          .getElementById("batchCategoryInput")
          .value.trim();
        if (!category) {
          showToast("请输入分类名称", "error");
          return;
        }
        if (sensitiveSelectedIds.size === 0) {
          showToast("请先选择敏感词", "error");
          return;
        }
        try {
          await api("/api/admin/sensitive-words/batch-category", "PUT", {
            ids: Array.from(sensitiveSelectedIds),
            category,
          });
          showToast(
            `已将 ${sensitiveSelectedIds.size} 个敏感词设为「${category}」`,
            "success"
          );
          clearSensitiveSelection();
          loadSensitiveWords(sensitivePage);
        } catch (e) {
          showToast("批量设置分类失败: " + e.message, "error");
        }
      }

      async function batchDeleteSensitive() {
        if (sensitiveSelectedIds.size === 0) {
          showToast("请先选择敏感词", "error");
          return;
        }
        if (!confirm(`确定删除选中的 ${sensitiveSelectedIds.size} 个敏感词？`))
          return;
        try {
          await api("/api/admin/sensitive-words/batch-delete", "POST", {
            ids: Array.from(sensitiveSelectedIds),
          });
          showToast(`已删除 ${sensitiveSelectedIds.size} 个敏感词`, "success");
          clearSensitiveSelection();
          loadSensitiveWords(sensitivePage);
        } catch (e) {
          showToast("批量删除失败: " + e.message, "error");
        }
      }

      function showImportModal() {
        document.getElementById("importText").value = "";
        document.getElementById("importFile").value = "";
        document.getElementById("importPreview").innerHTML = "";
        document.getElementById("importModal").classList.remove("hidden");
      }
      function hideImportModal() {
        document.getElementById("importModal").classList.add("hidden");
      }

      function loadImportFile() {
        const file = document.getElementById("importFile").files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            document.getElementById("importText").value = e.target.result;
            previewImport();
          };
          reader.readAsText(file);
        }
      }

      function showSensitiveImportModal() {
        document.getElementById("sensitiveImportText").value = "";
        document.getElementById("sensitiveImportFile").value = "";
        document.getElementById("sensitiveImportPreview").innerHTML = "";
        document
          .getElementById("sensitiveImportModal")
          .classList.remove("hidden");
      }
      function hideSensitiveImportModal() {
        document.getElementById("sensitiveImportModal").classList.add("hidden");
      }

      function loadSensitiveFile() {
        const file = document.getElementById("sensitiveImportFile").files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            document.getElementById("sensitiveImportText").value =
              e.target.result;
            const lines = e.target.result
              .split("\n")
              .filter((l) => l.trim() && !l.trim().startsWith("#"));
            document.getElementById(
              "sensitiveImportPreview"
            ).innerHTML = `将导入 <strong>${lines.length}</strong> 个敏感词（已跳过注释）`;
          };
          reader.readAsText(file);
        }
      }

      async function clearAllSensitiveWords() {
        if (!confirm("确定要清空所有敏感词吗？此操作不可恢复！")) {
          return;
        }
        try {
          await api("/api/admin/sensitive-words/clear", "DELETE");
          showToast("已清空所有敏感词", "success");
          loadSensitiveWords();
        } catch (e) {
          showToast("清空失败: " + e.message, "error");
        }
      }

      async function doSensitiveImport() {
        const text = document.getElementById("sensitiveImportText").value;
        const category = document.getElementById(
          "sensitiveImportCategory"
        ).value;
        const words = text
          .split("\n")
          .map((w) => w.trim())
          .filter((w) => w.length > 0 && !w.startsWith("#"));

        if (words.length === 0) {
          showToast("没有可导入的敏感词", "error");
          return;
        }

        const preview = document.getElementById("sensitiveImportPreview");
        const importBtn = document.querySelector(
          '#sensitiveImportModal button[onclick="doSensitiveImport()"]'
        );
        importBtn.disabled = true;
        importBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin mr-2"></i>导入中...';
        preview.innerHTML = `正在批量导入 <strong>${words.length}</strong> 个敏感词...`;

        try {
          const result = await api("/api/admin/sensitive-words/batch", "POST", {
            words: words,
            category: category || "导入",
          });
          showToast(
            `导入完成！新增 ${result.added}/${result.total} 个敏感词`,
            "success"
          );
        } catch (e) {
          showToast("导入失败: " + e.message, "error");
        }

        importBtn.disabled = false;
        importBtn.innerHTML = "导入";
        hideSensitiveImportModal();
        loadSensitiveWords();
      }

      function previewImport() {
        const text = document.getElementById("importText").value;
        let sep = document.getElementById("importSeparator").value;
        if (sep === "\\n\\n") sep = "\n\n";
        if (sep === "\\n") sep = "\n";

        const parts = text
          .split(sep)
          .map((p) => p.trim())
          .filter((p) => p.length > 0);
        document.getElementById(
          "importPreview"
        ).innerHTML = `将导入 <strong>${parts.length}</strong> 条知识`;
      }

      async function doImport() {
        const text = document.getElementById("importText").value;
        let sep = document.getElementById("importSeparator").value;
        if (sep === "\\n\\n") sep = "\n\n";
        if (sep === "\\n") sep = "\n";
        const category = document.getElementById("importCategory").value;

        const parts = text
          .split(sep)
          .map((p) => p.trim())
          .filter((p) => p.length > 0);
        if (parts.length === 0) {
          showToast("没有可导入的内容", "error");
          return;
        }

        // 添加loading状态
        const importBtn = document.querySelector(
          '#importModal button[onclick="doImport()"]'
        );
        const preview = document.getElementById("importPreview");
        importBtn.disabled = true;
        importBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin mr-2"></i>导入中...';
        preview.innerHTML = `正在导入 <strong>0/${parts.length}</strong> 条知识...`;

        let success = 0;
        let failed = 0;
        for (const part of parts) {
          const lines = part.split("\n");
          const title = lines[0].replace(/^#+\s*/, "").substring(0, 100);
          const content = part;

          try {
            await api("/api/knowledge/", "POST", {
              title: title || "导入知识",
              content: content,
              category: category || "导入",
            });
            success++;
          } catch (e) {
            failed++;
          }
          preview.innerHTML = `正在导入 <strong>${success + failed}/${
            parts.length
          }</strong> 条知识...`;
        }

        importBtn.disabled = false;
        importBtn.innerHTML = "导入";

        if (success > 0) {
          showToast(`成功导入 ${success}/${parts.length} 条知识`, "success");
        } else {
          showToast(`导入失败，请检查内容格式`, "error");
        }
        hideImportModal();
        loadKnowledge();
      }

      let editingKbId = null;

      function showKnowledgeModal() {
        editingKbId = null;
        document.getElementById("kbTitle").value = "";
        document.getElementById("kbContent").value = "";
        document.getElementById("kbKeywords").value = "";
        document.getElementById("kbCategory").value = "";
        document.getElementById("knowledgeModal").classList.remove("hidden");
      }
      function hideKnowledgeModal() {
        document.getElementById("knowledgeModal").classList.add("hidden");
      }

      function editKnowledge(id) {
        const kb = knowledgeData.find((k) => k.id === id);
        if (kb) {
          editingKbId = id;
          document.getElementById("kbTitle").value = kb.title || "";
          document.getElementById("kbContent").value = kb.content || "";
          document.getElementById("kbKeywords").value = kb.keywords || "";
          document.getElementById("kbCategory").value = kb.category || "";
          document.getElementById("knowledgeModal").classList.remove("hidden");
        }
      }
      function showBlacklistModal() {
        document.getElementById("blacklistModal").classList.remove("hidden");
      }
      function hideBlacklistModal() {
        document.getElementById("blacklistModal").classList.add("hidden");
      }
      function showChannelModal() {
        document.getElementById("channelModal").classList.remove("hidden");
      }
      function hideChannelModal() {
        document.getElementById("channelModal").classList.add("hidden");
      }
      function showSensitiveModal() {
        document.getElementById("sensitiveModal").classList.remove("hidden");
      }
      function hideSensitiveModal() {
        document.getElementById("sensitiveModal").classList.add("hidden");
      }

      function toggleDuration() {
        document.getElementById("blDuration").disabled =
          document.getElementById("blPermanent").checked;
      }

      // CRUD operations
      async function addKnowledge() {
        const data = {
          title: document.getElementById("kbTitle").value,
          content: document.getElementById("kbContent").value,
          keywords: document.getElementById("kbKeywords").value,
          category: document.getElementById("kbCategory").value,
        };

        if (editingKbId) {
          await api(`/api/knowledge/${editingKbId}`, "PUT", data);
        } else {
          await api("/api/knowledge/", "POST", data);
        }
        hideKnowledgeModal();
        loadKnowledge();
      }

      async function deleteKnowledge(id) {
        if (confirm("确定删除？")) {
          await api(`/api/knowledge/${id}`, "DELETE");
          loadKnowledge();
        }
      }

      async function addBlacklist() {
        await api("/api/admin/blacklist", "POST", {
          discord_id: document.getElementById("blDiscordId").value,
          username: document.getElementById("blUsername").value,
          reason: document.getElementById("blReason").value,
          is_permanent: document.getElementById("blPermanent").checked,
          duration_minutes:
            parseInt(document.getElementById("blDuration").value) || null,
        });
        hideBlacklistModal();
        loadBlacklist();
      }

      async function removeBlacklist(discordId) {
        if (confirm("确定解禁？")) {
          await api(`/api/admin/blacklist/${discordId}`, "DELETE");
          loadBlacklist();
        }
      }

      async function addChannel() {
        const botId = document.getElementById("chBotId").value || "yu";
        await api("/api/admin/channels", "POST", {
          bot_id: botId,
          channel_id: document.getElementById("chChannelId").value,
          guild_id: document.getElementById("chGuildId").value,
          channel_name: document.getElementById("chName").value,
        });
        hideChannelModal();
        loadChannels();
      }

      async function removeChannel(botId, channelId) {
        if (confirm("确定移除？")) {
          await api(`/api/admin/channels/${botId}/${channelId}`, "DELETE");
          loadChannels();
        }
      }

      async function fetchBotChannels() {
        const botId = document.getElementById("chBotId").value || "yu";
        const tree = document.getElementById("channelTree");
        tree.innerHTML =
          '<p class="text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>正在获取...</p>';

        try {
          const guilds = await api(`/api/admin/bot-channels/${botId}`);
          if (!guilds || guilds.length === 0) {
            tree.innerHTML = `
              <div class="text-center py-4">
                <i class="fas fa-robot text-gray-400 text-2xl mb-2"></i>
                <p class="text-gray-500 text-sm">暂无频道数据</p>
                <p class="text-gray-400 text-xs mt-1">请确保 Bot (ID: ${botId}) 已启动并连接到Discord</p>
                <p class="text-gray-400 text-xs">Bot启动后会自动上报频道列表</p>
              </div>`;
            return;
          }

          let html = "";
          for (const guild of guilds) {
            html += `<div class="mb-3">
              <div class="font-bold text-gray-700 mb-1">📁 ${guild.guild_name}</div>
              <div class="pl-4 space-y-1">`;

            for (const ch of guild.channels) {
              const icon =
                ch.type === "forum" ? "📋" : ch.type === "thread" ? "💬" : "#";
              html += `<div class="flex items-center justify-between hover:bg-gray-100 px-2 py-1 rounded cursor-pointer"
                onclick="selectChannel('${ch.channel_id}', '${guild.guild_id}', '${ch.channel_name}')">
                <span>${icon} ${ch.channel_name}</span>
                <button class="text-xs text-purple-600 hover:text-purple-800">选择</button>
              </div>`;
            }
            html += "</div></div>";
          }
          tree.innerHTML = html;
        } catch (e) {
          tree.innerHTML =
            '<p class="text-red-500"><i class="fas fa-exclamation-circle mr-1"></i>获取失败，请检查网络连接</p>';
        }
      }

      function selectChannel(channelId, guildId, channelName) {
        document.getElementById("chChannelId").value = channelId;
        document.getElementById("chGuildId").value = guildId;
        document.getElementById("chName").value = channelName;
      }

      async function addSensitiveWord() {
        await api("/api/admin/sensitive-words", "POST", {
          word: document.getElementById("swWord").value,
          category: document.getElementById("swCategory").value,
        });
        hideSensitiveModal();
        loadSensitiveWords();
      }

      async function removeSensitiveWord(id) {
        if (confirm("确定删除？")) {
          await api(`/api/admin/sensitive-words/${id}`, "DELETE");
          loadSensitiveWords();
        }
      }

      // LLM Config
      async function loadLLMConfig() {
        try {
          const config = await api("/api/admin/llm-config");
          document.getElementById("llmBaseUrl").value = config.base_url || "";
          // 显示与密钥长度相当的星号，让用户知道密钥已保存
          const keyLen = config.api_key ? config.api_key.length : 0;
          document.getElementById("llmApiKey").value =
            keyLen > 0 ? "*".repeat(Math.min(keyLen, 50)) : "";
          document.getElementById("llmModelCustom").value = config.model || "";
          document.getElementById("llmStream").checked =
            config.stream !== false;

          // 保存当前模型到手动输入框，并尝试添加到下拉列表
          const currentModel = config.model || "";
          document.getElementById("llmModelCustom").value = currentModel;
          if (currentModel) {
            const select = document.getElementById("llmModel");
            // 检查是否已存在
            let exists = false;
            for (let opt of select.options) {
              if (opt.value === currentModel) {
                exists = true;
                opt.selected = true;
                break;
              }
            }
            if (!exists) {
              const option = document.createElement("option");
              option.value = currentModel;
              option.textContent = currentModel + " (当前)";
              option.selected = true;
              select.appendChild(option);
            }
          }
        } catch (e) {
          console.error(e);
        }
      }

      async function saveLLMConfig() {
        const apiKey = document.getElementById("llmApiKey").value;
        const modelSelect = document.getElementById("llmModel").value;
        const modelCustom = document
          .getElementById("llmModelCustom")
          .value.trim();
        const model = modelCustom || modelSelect;
        const stream = document.getElementById("llmStream").checked;

        if (!model) {
          showToast("请选择或输入模型名称", "error");
          return;
        }

        const data = {
          base_url: document.getElementById("llmBaseUrl").value,
          model: model,
          stream: stream,
        };
        // 如果密钥不是全星号占位符，才传递密钥
        if (apiKey && !/^\*+$/.test(apiKey)) {
          data.api_key = apiKey;
        }

        try {
          await api("/api/admin/llm-config", "PUT", data);
          showToast("保存成功！模型: " + model, "success");
          loadLLMConfig(); // 重新加载显示
        } catch (e) {
          showToast("保存失败: " + e.message, "error");
        }
      }

      async function fetchModels() {
        const status = document.getElementById("modelStatus");
        const baseUrl = document.getElementById("llmBaseUrl").value;
        const apiKey = document.getElementById("llmApiKey").value;

        if (!baseUrl || !apiKey || apiKey === "********") {
          status.textContent = "请先填写API地址和密钥";
          status.className = "text-sm text-red-500 mt-1";
          return;
        }

        status.textContent = "正在获取模型列表...";
        status.className = "text-sm text-blue-500 mt-1";

        try {
          // 使用当前输入框的值拉取模型
          const params = new URLSearchParams({ base_url: baseUrl });
          // 如果密钥不是全星号占位符，才传递密钥
          if (apiKey && !/^\*+$/.test(apiKey)) {
            params.set("api_key", apiKey);
          }
          const result = await api(`/api/admin/llm-models?${params}`);
          const select = document.getElementById("llmModel");
          select.innerHTML = '<option value="">请选择模型</option>';

          for (const model of result.models) {
            const option = document.createElement("option");
            option.value = model;
            option.textContent = model;
            select.appendChild(option);
          }

          status.textContent = `成功获取 ${result.models.length} 个模型`;
          status.className = "text-sm text-green-500 mt-1";
        } catch (e) {
          status.textContent = "获取失败：" + (e.message || "请检查API配置");
          status.className = "text-sm text-red-500 mt-1";
        }
      }

      // Bot Config
      async function loadBotConfigs() {
        try {
          const configs = await api("/api/admin/bot-config");
          document.getElementById("botConfigList").innerHTML =
            configs.length === 0
              ? '<div class="bg-white rounded-xl p-6 shadow-sm text-gray-500">暂无Bot配置，点击右上角添加</div>'
              : configs
                  .map(
                    (bc) => `
              <div class="bg-white rounded-xl p-6 shadow-sm">
                <div class="flex justify-between items-start">
                  <div>
                    <h3 class="text-lg font-bold text-gray-800">${
                      bc.bot_name || bc.bot_id
                    }</h3>
                    <p class="text-sm text-gray-500">ID: ${bc.bot_id}</p>
                  </div>
                  <div class="flex space-x-2">
                    <button onclick="editBotConfig('${
                      bc.bot_id
                    }')" class="text-indigo-600 hover:text-indigo-800">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteBotConfig('${
                      bc.bot_id
                    }')" class="text-red-600 hover:text-red-800">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
                <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
                  <div><span class="text-gray-500">上下文条数：</span>${
                    bc.context_limit
                  }</div>
                  <div><span class="text-gray-500">状态：</span>${
                    bc.is_active ? "启用" : "禁用"
                  }</div>
                </div>
                <div class="mt-3 text-sm text-gray-600 truncate">
                  <span class="text-gray-500">人设：</span>${(
                    bc.system_prompt || ""
                  ).substring(0, 100)}...
                </div>
              </div>
            `
                  )
                  .join("");
        } catch (e) {
          console.error(e);
        }
      }

      let editingBotId = null;

      function showBotConfigModal() {
        editingBotId = null;
        document.getElementById("bcBotId").value = "";
        document.getElementById("bcBotId").disabled = false;
        document.getElementById("bcBotName").value = "";
        document.getElementById("bcSystemPrompt").value = "";
        document.getElementById("bcContextLimit").value = "10";
        document.getElementById("bcAdminIds").value = "";
        document.getElementById("bcChatModeMulti").checked = true;
        document.getElementById("botConfigModal").classList.remove("hidden");
      }

      function hideBotConfigModal() {
        document.getElementById("botConfigModal").classList.add("hidden");
      }

      async function editBotConfig(botId) {
        editingBotId = botId;
        const config = await api(`/api/admin/bot-config/${botId}`);
        document.getElementById("bcBotId").value = config.bot_id;
        document.getElementById("bcBotId").disabled = true;
        document.getElementById("bcBotName").value = config.bot_name || "";
        document.getElementById("bcSystemPrompt").value =
          config.system_prompt || "";
        document.getElementById("bcContextLimit").value =
          config.context_limit || 10;
        document.getElementById("bcAdminIds").value = config.admin_ids || "";
        if (config.chat_mode === "qa") {
          document.getElementById("bcChatModeQA").checked = true;
        } else if (config.chat_mode === "single") {
          document.getElementById("bcChatModeSingle").checked = true;
        } else {
          document.getElementById("bcChatModeMulti").checked = true;
        }
        document.getElementById("botConfigModal").classList.remove("hidden");
      }

      async function saveBotConfig() {
        const botId = editingBotId || document.getElementById("bcBotId").value;
        let chatMode = "multi";
        if (document.getElementById("bcChatModeQA").checked) {
          chatMode = "qa";
        } else if (document.getElementById("bcChatModeSingle").checked) {
          chatMode = "single";
        }
        const data = {
          bot_id: botId,
          bot_name: document.getElementById("bcBotName").value,
          system_prompt: document.getElementById("bcSystemPrompt").value,
          context_limit:
            parseInt(document.getElementById("bcContextLimit").value) || 10,
          admin_ids: document.getElementById("bcAdminIds").value,
          chat_mode: chatMode,
        };

        if (editingBotId) {
          await api(`/api/admin/bot-config/${botId}`, "PUT", data);
        } else {
          await api("/api/admin/bot-config", "POST", data);
        }
        hideBotConfigModal();
        loadBotConfigs();
      }

      async function deleteBotConfig(botId) {
        if (confirm("确定删除此Bot配置？")) {
          await api(`/api/admin/bot-config/${botId}`, "DELETE");
          loadBotConfigs();
        }
      }

      // Update showTab to handle new tabs
      const originalShowTab = showTab;
      showTab = function (tabId) {
        document
          .querySelectorAll(".tab-content")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".sidebar-item")
          .forEach((s) => s.classList.remove("active"));
        document.getElementById(tabId).classList.add("active");
        event.target.closest(".sidebar-item").classList.add("active");

        switch (tabId) {
          case "dashboard":
            loadDashboard();
            break;
          case "knowledge":
            loadKnowledge();
            break;
          case "blacklist":
            loadBlacklist();
            break;
          case "channels":
            loadChannels();
            break;
          case "memories":
            loadMemories();
            break;
          case "sensitive":
            loadSensitiveWords();
            break;
          case "llmconfig":
            loadLLMConfig();
            loadEmbeddingConfig();
            break;
          case "botconfig":
            loadBotConfigs();
            break;
          case "llmpool":
            loadLLMPool();
            break;
        }
      };

      // ========== LLM Pool Functions ==========
      async function loadLLMPool() {
        try {
          const data = await api("/api/admin/llm-pool");
          const models = data.models || [];

          document.getElementById("poolStatus").innerHTML =
            models.length > 0
              ? `<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i>已启用 ${data.enabled_count}/${models.length} 个模型</span>`
              : `<span class="text-gray-500"><i class="fas fa-info-circle mr-1"></i>未配置，使用默认API</span>`;

          document.getElementById("llmPoolTable").innerHTML =
            models.length === 0
              ? `<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">暂无模型，点击"添加模型"开始配置</td></tr>`
              : models
                  .map(
                    (m) => `
              <tr>
                <td class="px-6 py-4 text-sm font-medium text-gray-900">${
                  m.name || "-"
                }</td>
                <td class="px-6 py-4 text-sm text-gray-500">${m.base_url}</td>
                <td class="px-6 py-4 text-sm text-gray-500">${m.model}</td>
                <td class="px-6 py-4">
                  <button onclick="togglePoolModel(${m.index}, ${!m.enabled})" 
                    class="px-2 py-1 text-xs rounded-full ${
                      m.enabled
                        ? "bg-green-100 text-green-800"
                        : "bg-gray-100 text-gray-800"
                    }">
                    ${m.enabled ? "启用" : "禁用"}
                  </button>
                </td>
                <td class="px-6 py-4 space-x-2">
                  <button onclick="testExistingModel(${
                    m.index
                  })" class="text-green-600 hover:text-green-800" title="测试连接">
                    <i class="fas fa-plug"></i>
                  </button>
                  <button onclick="removeFromPool(${
                    m.index
                  })" class="text-red-600 hover:text-red-800" title="删除">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
            `
                  )
                  .join("");
        } catch (e) {
          console.error("Error loading LLM pool:", e);
        }
      }

      function showLLMPoolModal() {
        document.getElementById("llmPoolModal").classList.remove("hidden");
        document.getElementById("poolName").value = "";
        document.getElementById("poolBaseUrl").value = "";
        document.getElementById("poolApiKey").value = "";
        document.getElementById("poolModel").value = "";
      }

      function hideLLMPoolModal() {
        document.getElementById("llmPoolModal").classList.add("hidden");
      }

      async function addToLLMPool() {
        const data = {
          name: document.getElementById("poolName").value,
          base_url: document.getElementById("poolBaseUrl").value,
          api_key: document.getElementById("poolApiKey").value,
          model: document.getElementById("poolModel").value,
        };

        if (!data.base_url || !data.api_key || !data.model) {
          showToast("请填写API地址、密钥和模型名称", "error");
          return;
        }

        try {
          await api("/api/admin/llm-pool", "POST", data);
          hideLLMPoolModal();
          loadLLMPool();
        } catch (e) {
          showToast("添加失败：" + e.message, "error");
        }
      }

      async function removeFromPool(index) {
        if (confirm("确定删除此模型？")) {
          try {
            await api(`/api/admin/llm-pool/${index}`, "DELETE");
            loadLLMPool();
          } catch (e) {
            showToast("删除失败：" + e.message, "error");
          }
        }
      }

      async function togglePoolModel(index, enabled) {
        try {
          await api(`/api/admin/llm-pool/${index}/toggle`, "PUT", { enabled });
          loadLLMPool();
        } catch (e) {
          showToast("操作失败：" + e.message, "error");
        }
      }

      async function testExistingModel(index) {
        try {
          const result = await api(`/api/admin/llm-pool/${index}/test`, "POST");
          if (result.success) {
            showToast("连接成功", "success");
          } else {
            showToast(result.message, "error");
          }
        } catch (e) {
          showToast("测试失败：" + e.message, "error");
        }
      }

      // ========== Embedding Config Functions ==========
      async function loadEmbeddingConfig() {
        try {
          const data = await api("/api/admin/embedding-config");
          document.getElementById("embeddingBaseUrl").value =
            data.base_url || "";
          document.getElementById("embeddingApiKey").value = data.api_key || "";
          // 如果有已保存的模型，添加到下拉框并选中
          const select = document.getElementById("embeddingModel");
          const model = data.model || "";
          if (model) {
            // 检查是否已存在该选项
            let exists = false;
            for (let opt of select.options) {
              if (opt.value === model) {
                exists = true;
                break;
              }
            }
            if (!exists) {
              const option = document.createElement("option");
              option.value = model;
              option.textContent = model + " (已保存)";
              select.appendChild(option);
            }
            select.value = model;
          }
        } catch (e) {
          console.error("Load embedding config error:", e);
        }
      }

      async function saveEmbeddingConfig() {
        const modelSelect = document.getElementById("embeddingModel").value;
        const modelCustom = document
          .getElementById("embeddingModelCustom")
          .value.trim();
        const model = modelCustom || modelSelect;

        if (!model) {
          showToast("请选择或输入模型名称", "error");
          return;
        }

        try {
          await api("/api/admin/embedding-config", "PUT", {
            base_url: document.getElementById("embeddingBaseUrl").value,
            api_key: document.getElementById("embeddingApiKey").value,
            model: model,
          });
          showToast("向量配置已保存", "success");
        } catch (e) {
          showToast("保存失败：" + e.message, "error");
        }
      }

      async function fetchEmbeddingModels() {
        const baseUrl = document.getElementById("embeddingBaseUrl").value;
        const apiKey = document.getElementById("embeddingApiKey").value;

        if (!baseUrl || !apiKey) {
          showToast("请先填写API地址和密钥", "error");
          return;
        }

        const status = document.getElementById("embeddingStatus");
        const select = document.getElementById("embeddingModel");
        status.textContent = "正在拉取模型列表...";
        status.className = "text-sm text-blue-500";

        try {
          const resp = await fetch(baseUrl.replace(/\/$/, "") + "/models", {
            headers: { Authorization: `Bearer ${apiKey}` },
          });
          const data = await resp.json();
          const models = data.data || [];

          if (models.length > 0) {
            // 填充下拉框
            const currentValue = select.value;
            select.innerHTML = '<option value="">-- 选择模型 --</option>';
            models.forEach((m) => {
              const option = document.createElement("option");
              option.value = m.id;
              option.textContent = m.id;
              select.appendChild(option);
            });
            // 恢复之前选中的值
            if (currentValue) select.value = currentValue;

            status.textContent = `找到 ${models.length} 个模型`;
            status.className = "text-sm text-green-600";
            showToast("模型列表已更新", "success");
          } else {
            status.textContent = "未找到模型";
            status.className = "text-sm text-yellow-600";
          }
        } catch (e) {
          status.textContent = "拉取失败：" + e.message;
          status.className = "text-sm text-red-600";
        }
      }

      async function testEmbeddingConnection() {
        const baseUrl = document.getElementById("embeddingBaseUrl").value;
        const apiKey = document.getElementById("embeddingApiKey").value;
        const modelSelect = document.getElementById("embeddingModel").value;
        const modelCustom = document
          .getElementById("embeddingModelCustom")
          .value.trim();
        const model = modelCustom || modelSelect;

        if (!baseUrl || !apiKey || !model) {
          showToast("请先填写API地址、密钥和模型名称", "error");
          return;
        }

        const status = document.getElementById("embeddingStatus");
        status.textContent = "正在测试连接...";
        status.className = "text-sm text-blue-500";

        try {
          const result = await api("/api/admin/embedding-config/test", "POST", {
            base_url: baseUrl,
            api_key: apiKey,
            model: model,
          });

          if (result.success) {
            status.textContent = "✓ " + result.message;
            status.className = "text-sm text-green-600";
            showToast("连接成功", "success");
          } else {
            status.textContent = "✗ " + result.message;
            status.className = "text-sm text-red-600";
            showToast(result.message, "error");
          }
        } catch (e) {
          status.textContent = "✗ 测试失败：" + e.message;
          status.className = "text-sm text-red-600";
          showToast("测试失败：" + e.message, "error");
        }
      }

      // ========== Pool Model Fetch & Test ==========
      async function testPoolConnection() {
        const baseUrl = document.getElementById("poolBaseUrl").value;
        const apiKey = document.getElementById("poolApiKey").value;
        const model = document.getElementById("poolModel").value;

        if (!baseUrl || !apiKey || !model) {
          showToast("请先填写API地址、密钥和模型名称", "error");
          return;
        }

        const status = document.getElementById("poolModelStatus");
        status.textContent = "正在测试连接...";
        status.className = "text-sm text-gray-500 mb-3";

        try {
          const result = await api("/api/admin/llm-pool/test", "POST", {
            base_url: baseUrl,
            api_key: apiKey,
            model: model,
          });

          if (result.success) {
            status.textContent = "✓ " + result.message;
            status.className = "text-sm text-green-600 mb-3";
            showToast("连接成功", "success");
          } else {
            status.textContent = "✗ " + result.message;
            status.className = "text-sm text-red-600 mb-3";
            showToast(result.message, "error");
          }
        } catch (e) {
          status.textContent = "✗ 测试失败：" + e.message;
          status.className = "text-sm text-red-600 mb-3";
          showToast("测试失败：" + e.message, "error");
        }
      }

      async function fetchPoolModels() {
        const baseUrl = document.getElementById("poolBaseUrl").value;
        const apiKey = document.getElementById("poolApiKey").value;

        if (!baseUrl || !apiKey) {
          showToast("请先填写API地址和密钥", "error");
          return;
        }

        const status = document.getElementById("poolModelStatus");
        status.textContent = "正在拉取模型列表...";

        try {
          const resp = await fetch(baseUrl.replace(/\/$/, "") + "/models", {
            headers: { Authorization: `Bearer ${apiKey}` },
          });

          if (!resp.ok) throw new Error("请求失败");

          const data = await resp.json();
          const models = data.data || [];

          const select = document.getElementById("poolModelSelect");
          select.innerHTML =
            '<option value="">选择模型</option>' +
            models
              .map((m) => `<option value="${m.id}">${m.id}</option>`)
              .join("");

          status.textContent = `找到 ${models.length} 个模型`;
        } catch (e) {
          status.textContent = "拉取失败：" + e.message;
        }
      }

      // ========== Knowledge Vector Functions ==========
      async function rebuildKnowledgeEmbeddings() {
        if (!confirm("确定要重建所有知识库的向量？这可能需要一些时间。"))
          return;

        try {
          const btn = event.target;
          btn.disabled = true;
          btn.innerHTML =
            '<i class="fas fa-spinner fa-spin mr-2"></i>处理中...';

          const result = await api(
            "/api/admin/knowledge/rebuild-embeddings",
            "POST"
          );
          showToast(`成功重建 ${result.rebuilt} 条知识的向量`, "success");
          loadKnowledge();
        } catch (e) {
          showToast("重建失败：" + e.message, "error");
        } finally {
          event.target.disabled = false;
          event.target.innerHTML =
            '<i class="fas fa-sync-alt mr-2"></i>重建向量';
        }
      }

      // Enter key login
      document
        .getElementById("adminSecret")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter") login();
        });
    </script>
  </body>
</html>
